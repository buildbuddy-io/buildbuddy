<!doctype html>
<html lang="en" dir="ltr" class="plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">How to migrate an iOS app to Bazel | BuildBuddy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.buildbuddy.io/blog/how-to-migrate-an-ios-app-to-bazel"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:description" content="BuildBuddy provides enterprise features for Bazel — the open source build system that allows you to build and test software 10x faster."><meta data-rh="true" property="og:title" content="How to migrate an iOS app to Bazel | BuildBuddy"><meta data-rh="true" name="description" content="Wondering how to migrate your Apple-based project to Bazel? Whether it&#x27;s iOS, macOS, watchOS, tvOS, or visionOS, this guide is for you."><meta data-rh="true" property="og:description" content="Wondering how to migrate your Apple-based project to Bazel? Whether it&#x27;s iOS, macOS, watchOS, tvOS, or visionOS, this guide is for you."><meta data-rh="true" property="og:image" content="https://www.buildbuddy.io/img/ios_bazel.png"><meta data-rh="true" name="twitter:image" content="https://www.buildbuddy.io/img/ios_bazel.png"><link data-rh="true" rel="icon" href="/img/favicon_black.svg"><link data-rh="true" rel="canonical" href="https://www.buildbuddy.io/blog/how-to-migrate-an-ios-app-to-bazel"><link data-rh="true" rel="alternate" href="https://www.buildbuddy.io/blog/how-to-migrate-an-ios-app-to-bazel" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.buildbuddy.io/blog/how-to-migrate-an-ios-app-to-bazel" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="BuildBuddy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="BuildBuddy Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-156160991-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="/assets/css/styles.a7b9f9c2.css">
<script src="/assets/js/runtime~main.3b5edd4c.js" defer="defer"></script>
<script src="/assets/js/main.b18c0757.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="BuildBuddy Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32px" width="191px"><img src="/img/logo_white.svg" alt="BuildBuddy Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32px" width="191px"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/features">Features</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/ui">Build &amp; Test UI</a></li><li><a class="dropdown__link" href="/remote-execution">Remote Execution</a></li><li><a class="dropdown__link" href="/remote-cache">Remote Cache</a></li><li><a class="dropdown__link" href="/workflows">Workflows</a></li><li><a class="dropdown__link" href="/cli">BuildBuddy CLI</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/blog">Blog</a></li><li><a href="https://github.com/buildbuddy-io/buildbuddy" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="http://community.buildbuddy.io/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Community<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a class="dropdown__link" href="/security">Security</a></li><li><a class="dropdown__link" href="/plugins">Plugins</a></li><li><a class="dropdown__link" href="/team">Team</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/introduction/">Docs</a><a class="navbar__item navbar__link" target="_self" href="/pricing">Pricing</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" target="_self" href="/contact">Contact</a><a href="https://app.buildbuddy.io/" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link">Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://app.buildbuddy.io/" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link sign-up">Sign up<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 blog-wrapper"><div class="blog-container margin-vert--lg"><div class="row"><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_TjLu">How to migrate an iOS app to Bazel</h1><div class="margin-vert--md"><div class="heading_cWLF"><div class="headingPhoto_YUAj"><a href="https://brentleyjones.com" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo undefined"><img src="https://avatars.githubusercontent.com/u/158658?v=4" alt="Brentley Jones"></a></div><div><span><a href="https://brentleyjones.com" target="_blank" rel="noopener noreferrer" class="authorName_Xags">Brentley Jones</a>, <span>Developer Evangelist @ BuildBuddy</span></span><time datetime="2024-03-13T08:00:00.000Z" class="blogPostDate_NeIP"><br>March 13, 2024<!-- --> <!-- --> · <!-- -->34 min read</time></div></div></div></header><div class="markdown"><p>Do you have an iOS app,
or really any Apple-based project,
that you want to migrate to Bazel?
With this guide I&#x27;ll show you how to migrate your project,
using the <a href="https://github.com/mastodon/mastodon-ios" target="_blank" rel="noopener noreferrer">Mastodon iOS</a> project as an example.</p>
<p>We will use iOS based rules in the example migration,
but similar rules exist in <a href="https://github.com/bazelbuild/rules_apple" target="_blank" rel="noopener noreferrer"><strong>rules_apple</strong></a> for the other Apple platforms,
including
macOS,
watchOS,
tvOS,
and visionOS.</p>
<p>The completed migration is available in <a href="https://github.com/brentleyjones/mastodon-ios/tree/bj/migrate-to-bazel" target="_blank" rel="noopener noreferrer">my fork of mastodon-ios</a>.
You can follow along with the changes made in the following sections by checking out <a href="https://github.com/brentleyjones/mastodon-ios/commit/c15c418cfc94f0ac2ccab9a10e7a4f08a2f402c4" target="_blank" rel="noopener noreferrer">this commit</a> first.
At the end of some sections there will be a link to a new commit that includes the changes mentioned up to that point.</p>
<p>If Bazel is completely new to you,
I recommend reading the official <a href="https://bazel.build/run/build" target="_blank" rel="noopener noreferrer">quick start guide</a>.
That will explain some foundational things that I don&#x27;t cover in this guide.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="table-of-contents">Table of contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of contents" title="Direct link to Table of contents">​</a></h2>
<nav class="toc"><ul>
<li><a href="#bootstrapping-bazel">Bootstrapping Bazel</a></li>
<li><a href="#defining-targets">Defining targets</a>
<ul>
<li><a href="#rules">Rules</a></li>
<li><a href="#translating-the-xcode-project">Translating the Xcode project</a></li>
</ul>
</li>
<li><a href="#integrating-with-xcode">Integrating with Xcode</a></li>
<li><a href="#leveraging-remote-caching-and-remote-execution">Leveraging remote caching and remote execution</a>
<ul>
<li><a href="#disk-cache">Disk cache</a></li>
<li><a href="#remote-cache">Remote cache</a></li>
<li><a href="#debugging-cache-hits">Debugging cache hits</a></li>
<li><a href="#rules_xcodeproj-cache-warming"><strong>rules_xcodeproj</strong> cache warming</a></li>
<li><a href="#build-event-service">Build event service</a></li>
<li><a href="#remote-execution">Remote execution</a></li>
</ul>
</li>
<li><a href="#optimizing">Optimizing</a>
<ul>
<li><a href="#optimal-bazel-settings">Optimal Bazel settings</a></li>
<li><a href="#modularization">Modularization</a></li>
</ul>
</li>
<li><a href="#next-steps">Next steps</a></li>
</ul></nav>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bootstrapping-bazel">Bootstrapping Bazel<a href="#bootstrapping-bazel" class="hash-link" aria-label="Direct link to Bootstrapping Bazel" title="Direct link to Bootstrapping Bazel">​</a></h2>
<p>Before we can start to define the structure of our project,
we need to get some foundational Bazel setup out of the way.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bazelisk">Bazelisk<a href="#bazelisk" class="hash-link" aria-label="Direct link to Bazelisk" title="Direct link to Bazelisk">​</a></h3>
<p>There are two main ways to run Bazel: directly or via <a href="https://github.com/bazelbuild/bazelisk" target="_blank" rel="noopener noreferrer">Bazelisk</a>.</p>
<p>For this migration I&#x27;m going to use Bazelisk.
I recommend using Bazelisk for multiple reasons:</p>
<ul>
<li>One installed binary supports multiple Bazel versions</li>
<li>The project&#x27;s supported Bazel version can be managed with a <code>.bazelversion</code> file</li>
<li>The <code>tools/bazel</code> wrapper script is automatically run if it exists</li>
<li>The Bazel community has largely settled on <a href="https://bazel.build/install/bazelisk" target="_blank" rel="noopener noreferrer">using Bazelisk as a best practice</a></li>
</ul>
<p>If you don&#x27;t already have Bazelisk installed,
I recommend installing it with Homebrew:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">brew install bazelisk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will install Bazelisk as <code>bazel</code>.
Because of this,
when you see <code>bazel</code> in future examples,
it&#x27;s actually running Bazelisk
(which then runs Bazel).</p>
<p>By the way,
because we are going to be using newer features of Bazel,
make sure your installed version of Bazelisk is at least v1.19.0.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bazelversion"><code>.bazelversion</code><a href="#bazelversion" class="hash-link" aria-label="Direct link to bazelversion" title="Direct link to bazelversion">​</a></h3>
<p>Now that we have Bazelisk installed,
we need to tell it which version of Bazel we want it to download and run for us.
We can do that by creating a <code>.bazelversion</code> file at the root of the project:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">echo &#x27;7.0.2&#x27; &gt; .bazelversion</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="modulebazel"><code>MODULE.bazel</code><a href="#modulebazel" class="hash-link" aria-label="Direct link to modulebazel" title="Direct link to modulebazel">​</a></h3>
<p>Since Bazel can be run in subdirectories of a project,
it uses the existence of a <a href="https://bazel.build/external/overview#repository" target="_blank" rel="noopener noreferrer">repository boundary marker file</a> to designate the root of the project
(which Bazel calls a <a href="https://bazel.build/external/overview#workspace" target="_blank" rel="noopener noreferrer">workspace</a>).
We&#x27;re going to use a <code>MODULE.bazel</code> file for this,
since we will eventually have <a href="https://bazel.build/external/overview#bzlmod" target="_blank" rel="noopener noreferrer">Bazel module dependencies</a> to declare.
We can start with an empty file to begin with:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">touch MODULE.bazel</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verifying">Verifying<a href="#verifying" class="hash-link" aria-label="Direct link to Verifying" title="Direct link to Verifying">​</a></h3>
<p>At this point we can verify that we have Bazel and Bazelisk configured properly by running <code>bazel info release</code>:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">bazel info release</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token output">release 7.0.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/7b55ceeaa71b7b2b4159c525b29dc4166c661896" target="_blank" rel="noopener noreferrer">this commit</a> we have Bazel bootstrapped for the Mastodon iOS project.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="defining-targets">Defining targets<a href="#defining-targets" class="hash-link" aria-label="Direct link to Defining targets" title="Direct link to Defining targets">​</a></h2>
<p>Now that we have the Bazel project bootstrapped,
we can start adding <a href="https://bazel.build/concepts/build-ref#targets" target="_blank" rel="noopener noreferrer">targets</a> to it.</p>
<p>Bazel targets are defined by instances of <a href="https://bazel.build/extending/rules" target="_blank" rel="noopener noreferrer">rules</a> in <a href="https://bazel.build/concepts/build-ref#packages" target="_blank" rel="noopener noreferrer">packages</a>.
Packages are defined by <a href="https://bazel.build/concepts/build-files" target="_blank" rel="noopener noreferrer"><code>BUILD</code></a> files.
First I&#x27;ll go over the rules we will use,
and then I&#x27;ll show how we use them to define our targets.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rules">Rules<a href="#rules" class="hash-link" aria-label="Direct link to Rules" title="Direct link to Rules">​</a></h3>
<p>I&#x27;m not going to cover every rule that you could use in an Apple-based project,
but I will cover some of the more popular/interesting ones,
even if they won&#x27;t all be used in this migration.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="swift_library"><code>swift_library</code><a href="#swift_library" class="hash-link" aria-label="Direct link to swift_library" title="Direct link to swift_library">​</a></h4>
<p>A <a href="https://github.com/bazelbuild/rules_swift/blob/1.16.0/doc/rules.md#swift_library" target="_blank" rel="noopener noreferrer"><code>swift_library</code></a> target defines a single Swift static library.</p>
<p>When built directly
(ideally though an <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_build_test" target="_blank" rel="noopener noreferrer"><code>ios_build_test</code></a> to ensure it&#x27;s in the correct configuration),
<code>swift_library</code> produces <code>.swiftmodule</code> and <code>.swiftdoc</code> files.
If the <a href="https://github.com/bazelbuild/rules_swift/blob/1.16.0/swift/internal/feature_names.bzl#L244-L246" target="_blank" rel="noopener noreferrer"><code>swift.enable_library_evolution</code></a> and <a href="https://github.com/bazelbuild/rules_swift/blob/1.16.0/swift/internal/feature_names.bzl#L252-L254" target="_blank" rel="noopener noreferrer"><code>swift.emit_swiftinterface</code></a> features are enabled,
it also produces a <code>.swiftinterface</code> file.
When depended on by an executable producing target,
such as <a href="#ios_application"><code>ios_application</code></a>,
it also produces a <code>.a</code> file.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="objc_library"><code>objc_library</code><a href="#objc_library" class="hash-link" aria-label="Direct link to objc_library" title="Direct link to objc_library">​</a></h4>
<p>An <a href="https://bazel.build/reference/be/objective-c#objc_library" target="_blank" rel="noopener noreferrer"><code>objc_library</code></a> target defines a single Objective-C static library.
Use it instead of <a href="#cc_library"><code>cc_library</code></a> when compiling Objective-C or Objective-C++ code.</p>
<p>When depended on by an executable producing target,
such as an <a href="#ios_application"><code>ios_application</code></a> target,
<code>objc_library</code> produces a <code>.a</code> file.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If <code>srcs</code> is empty,
an <code>objc_library</code> target acts as a collection of
headers,
defines,
include paths,
or linkopts,
which are propagated to dependent targets.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cc_library"><code>cc_library</code><a href="#cc_library" class="hash-link" aria-label="Direct link to cc_library" title="Direct link to cc_library">​</a></h4>
<p>A <a href="https://bazel.build/reference/be/c-cpp#cc_library" target="_blank" rel="noopener noreferrer"><code>cc_library</code></a> target defines a single C or C++ static library.
Use it when compiling C or C++ code.
While you can use <code>objc_library</code> to compile C or C++ code,
using <code>cc_library</code> is more efficient,
and is more clear in your intent.</p>
<p>When depended on by an executable producing target,
such as an <a href="#ios_application"><code>ios_application</code></a> target,
<code>cc_library</code> produces a <code>.a</code> file.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If <code>srcs</code> is empty,
a <code>cc_library</code> target acts as a collection of
headers,
defines,
include paths,
or linkopts,
which are propagated to dependent targets.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="experimental_mixed_language_library"><code>experimental_mixed_language_library</code><a href="#experimental_mixed_language_library" class="hash-link" aria-label="Direct link to experimental_mixed_language_library" title="Direct link to experimental_mixed_language_library">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-apple.md#experimental_mixed_language_library" target="_blank" rel="noopener noreferrer"><code>experimental_mixed_language_library</code></a> target defines an Objective-C and Swift mixed-language static library.
Use it for compiling mixed-language modules.</p>
<p><code>experimental_mixed_language_library</code> is actually a <a href="https://bazel.build/versions/7.0.0/extending/macros" target="_blank" rel="noopener noreferrer">macro</a> that creates
a <a href="#swift_library"><code>swift_library</code></a>,
an <a href="#objc_library"><code>objc_library</code></a>,
and some <a href="https://clang.llvm.org/docs/Modules.html#module-maps" target="_blank" rel="noopener noreferrer">modulemaps</a> to tie them together.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Due to poor build performance,
it is not recommended to have mixed-language modules.
It&#x27;s recommended to only use this macro as a migration stopgap until you are able to demix them.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="apple_intent_library"><code>apple_intent_library</code><a href="#apple_intent_library" class="hash-link" aria-label="Direct link to apple_intent_library" title="Direct link to apple_intent_library">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-resources.md#apple_intent_library" target="_blank" rel="noopener noreferrer"><code>apple_intent_library</code></a> target generates source files for an <code>.intentdefinition</code> file.
Use it if you have <code>.intentdefinition</code> resources.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-resources.md#swift_intent_library" target="_blank" rel="noopener noreferrer"><code>swift_intent_library</code></a> and <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-resources.md#objc_intent_library" target="_blank" rel="noopener noreferrer"><code>objc_intent_library</code></a> macros wrap <code>apple_intent_library</code> with <a href="#swift_library"><code>swift_library</code></a> and <a href="#objc_library"><code>objc_library</code></a> targets respectively.
Use them instead of <code>apple_intent_library</code> directly if possible.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="apple_resource_bundle"><code>apple_resource_bundle</code><a href="#apple_resource_bundle" class="hash-link" aria-label="Direct link to apple_resource_bundle" title="Direct link to apple_resource_bundle">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-resources.md#apple_resource_bundle" target="_blank" rel="noopener noreferrer"><code>apple_resource_bundle</code></a> target generates a resource bundle.
Use it if you require certain resources to be placed in a named <code>.bundle</code>,
instead of directly placed in your top level bundle
(e.g. an <code>.app</code>, <code>.framework</code> , or <code>.xctest</code>).</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><code>apple_resource_bundle</code> targets need to be listed in <code>data</code> attributes,
not <code>deps</code> attributes.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ios_application"><code>ios_application</code><a href="#ios_application" class="hash-link" aria-label="Direct link to ios_application" title="Direct link to ios_application">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_application" target="_blank" rel="noopener noreferrer"><code>ios_application</code></a> target generates an application bundle.</p>
<p>Unlike Xcode,
Bazel separates compilation and bundling targets.
This means that an <code>ios_application</code> target
(which is a bundling target)
doesn&#x27;t list its source files,
and instead requires that its primary module be a single static library dependency,
such as a <a href="#swift_library">swift_library</a> or an <a href="#objc_library">objc_library</a>
(which is a compilation target).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ios_app_clip"><code>ios_app_clip</code><a href="#ios_app_clip" class="hash-link" aria-label="Direct link to ios_app_clip" title="Direct link to ios_app_clip">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_app_clip" target="_blank" rel="noopener noreferrer"><code>ios_app_clip</code></a> target generates an app clip bundle.</p>
<p><code>ios_app_clip</code> is used nearly identically to <a href="#ios_application"><code>ios_application</code></a>
(since app clips are on-demand applications),
except that it also needs to be listed in a parent <code>ios_application</code>&#x27;s <code>app_clips</code> attribute.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ios_extension"><code>ios_extension</code><a href="#ios_extension" class="hash-link" aria-label="Direct link to ios_extension" title="Direct link to ios_extension">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_extension" target="_blank" rel="noopener noreferrer"><code>ios_extension</code></a> target generates an application extension bundle.</p>
<p>Similar to <a href="#ios_application"><code>ios_application</code></a>,
<code>ios_extension</code> defines a bundling target,
which means that it doesn&#x27;t list its source files,
and instead requires that its primary module be a single static library dependency,
such as a <a href="#swift_library">swift_library</a> or an <a href="#objc_library">objc_library</a>
(which is a compilation target).</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Extensions are listed in the <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_application-extensions" target="_blank" rel="noopener noreferrer"><code>extensions</code></a> attribute of the containing application instead of the <code>deps</code> attribute.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ios_framework"><code>ios_framework</code><a href="#ios_framework" class="hash-link" aria-label="Direct link to ios_framework" title="Direct link to ios_framework">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_framework" target="_blank" rel="noopener noreferrer"><code>ios_framework</code></a> target causes the <a href="#swift_library">static library</a> targets it depends on to be linked and bundled into a dynamic framework bundle,
instead of the top-level bundle target they would have ultimately been linked into
(e.g. an <code>.app</code>, <code>.framework</code> , or <code>.xctest</code>).
These libraries still need to be depended on by your top-level bundle target.
See the <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/frameworks.md" target="_blank" rel="noopener noreferrer">frameworks</a> <strong>rules_apple</strong> documentation for more information on how to use this rule.</p>
<p>Since library dependencies have to be listed in <code>deps</code> attributes,
regardless if you use dynamic frameworks or not,
conditionally setting <code>frameworks</code> on your top-level bundle targets can be an easy way to switch between dynamic and static linking.
This can enable workflows such as using dynamic frameworks for dev builds,
which has faster incremental linking,
and using static linking for release builds,
which has faster startup time.<sup><a href="#user-content-fn-mergable_libraries-2fd3bf" id="user-content-fnref-mergable_libraries-2fd3bf" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><code>ios_framework</code> is not intended to be used for distribution
(i.e. consumed by Xcode).
Use <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_dynamic_framework" target="_blank" rel="noopener noreferrer"><code>ios_dynamic_framework</code></a> for that.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ios_unit_test"><code>ios_unit_test</code><a href="#ios_unit_test" class="hash-link" aria-label="Direct link to ios_unit_test" title="Direct link to ios_unit_test">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_unit_test" target="_blank" rel="noopener noreferrer"><code>ios_unit_test</code></a> target generates a unit testing bundle.</p>
<p>Similar to <a href="#ios_application"><code>ios_application</code></a>,
<code>ios_unit_test</code> defines a bundling target,
which means that it doesn&#x27;t list its source files,
and instead requires that its primary module be a single static library dependency,
such as a <a href="#swift_library">swift_library</a> or an <a href="#objc_library">objc_library</a>
(which is a compilation target).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ios_ui_test"><code>ios_ui_test</code><a href="#ios_ui_test" class="hash-link" aria-label="Direct link to ios_ui_test" title="Direct link to ios_ui_test">​</a></h4>
<p>An <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_ui_test" target="_blank" rel="noopener noreferrer"><code>ios_ui_test</code></a> target generates a UI testing bundle.</p>
<p>Similar to <a href="#ios_application"><code>ios_application</code></a>,
<code>ios_ui_test</code> defines a bundling target,
which means that it doesn&#x27;t list its source files,
and instead requires that its primary module be a single static library dependency,
such as a <a href="#swift_library">swift_library</a> or an <a href="#objc_library">objc_library</a>
(which is a compilation target).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local_provisioning_profile"><code>local_provisioning_profile</code><a href="#local_provisioning_profile" class="hash-link" aria-label="Direct link to local_provisioning_profile" title="Direct link to local_provisioning_profile">​</a></h4>
<p>A <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-apple.md#local_provisioning_profile" target="_blank" rel="noopener noreferrer"><code>local_provisioning_profile</code></a> target defines a reference to a provisioning file that exists on the user&#x27;s machine.
Use it when your provisioning profile is not checked into the workspace,
such as per-user and/or managed by Xcode profiles.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="translating-the-xcode-project">Translating the Xcode project<a href="#translating-the-xcode-project" class="hash-link" aria-label="Direct link to Translating the Xcode project" title="Direct link to Translating the Xcode project">​</a></h3>
<p>When migrating a project that uses Xcode to build,
which the Mastodon iOS project does,
we have a blueprint in the form of the Xcode project that we can use to guide us on which Bazel targets we need to create.
Each Xcode target will map to one or more Bazel targets,
mostly formulaically.
And since we now know which rules we can use for those Bazel targets,
let&#x27;s get to translating.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dependencies">Dependencies<a href="#dependencies" class="hash-link" aria-label="Direct link to Dependencies" title="Direct link to Dependencies">​</a></h4>
<p>Before talking about how any given target is translated,
I wanted to mention how dependencies between targets are handled.</p>
<p>For each target dependency that an Xcode target has,
the corresponding Bazel target will have the same dependency listed in one of its dependency attributes.
For example,
if the Xcode target <code>A</code> depends on targets <code>B</code> and <code>C</code>,
then the Bazel target <code>//some:A</code> will have <code>//a/package:B</code> and <code>//another/pkg:C</code> included in its dependency attributes.</p>
<p>If a dependency is on a target that translates to multiple Bazel targets,
e.g. an <code>ios_extension</code> and <code>swift_library</code>,
then only the top-most target
(<code>ios_extension</code> in this example)
should be included in one of the Bazel target&#x27;s dependency attributes.</p>
<p>If a dependency is on a product defined in a Swift package,
then a label of the form <code>@swiftpkg_foo//:A</code>,
where <code>A</code> is a product in the <code>Foo</code> Swift package,
should be included in one of the Bazel target&#x27;s dependency attributes.
I&#x27;ll give more details on how Swift packages are handled with Bazel in a <a href="#swift-packages-swiftpm">later section</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="apple_support-rules_swift-rules_apple-and-bazel_skylib"><strong>apple_support</strong>, <strong>rules_swift</strong>, <strong>rules_apple</strong>, and <strong>bazel_skylib</strong><a href="#apple_support-rules_swift-rules_apple-and-bazel_skylib" class="hash-link" aria-label="Direct link to apple_support-rules_swift-rules_apple-and-bazel_skylib" title="Direct link to apple_support-rules_swift-rules_apple-and-bazel_skylib">​</a></h4>
<p>Before using rules from some of the core rulesets we need to add dependencies on
<strong>apple_support</strong>,
<strong>rules_swift</strong>,
<strong>rules_apple</strong>,
and <strong>bazel_skylib</strong>.
We do that by adding <code>bazel_dep</code>s to our <code>MODULE.bazel</code> file:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">MODULE.bazel</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">bazel_dep</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;apple_support&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1.14.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">bazel_dep</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;rules_swift&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1.16.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> repo_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;build_bazel_rules_swift&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">bazel_dep</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;rules_apple&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;3.3.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> repo_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;build_bazel_rules_apple&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">bazel_dep</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bazel_skylib&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1.5.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="static-libraries">Static libraries<a href="#static-libraries" class="hash-link" aria-label="Direct link to Static libraries" title="Direct link to Static libraries">​</a></h4>
<p>While the Mastodon iOS project doesn&#x27;t define any static library targets in its Xcode project
(though it implicitly does through its use of Swift packages,
which are discussed later),
I wanted to mention that they are translated 1:1 with <a href="#swift_library">static library</a> rules.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="provisioning-profiles">Provisioning profiles<a href="#provisioning-profiles" class="hash-link" aria-label="Direct link to Provisioning profiles" title="Direct link to Provisioning profiles">​</a></h4>
<p>If you have your provisioning profile stored in your workspace,
you can reference it directly with the <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_application-provisioning_profile" target="_blank" rel="noopener noreferrer"><code>provisioning_profile</code></a> attribute.
If your provisioning profile is instead stored in the default Xcode location
(i.e. <code>~/Library/MobileDevice/Provisioning Profiles</code>),
you&#x27;ll want to use the <a href="#local_provisioning_profile"><code>local_provisioning_profile</code></a> rule to reference it.
Finally,
if you use Xcode&#x27;s &quot;Automatic Code Signing&quot; feature,
you&#x27;ll want to use the <a href="https://github.com/MobileNativeFoundation/rules_xcodeproj/blob/1.17.0/docs/bazel.md#xcode_provisioning_profile" target="_blank" rel="noopener noreferrer"><code>xcode_provisioning_profile</code></a> rule as well.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="swift-packages-swiftpm">Swift packages (SwiftPM)<a href="#swift-packages-swiftpm" class="hash-link" aria-label="Direct link to Swift packages (SwiftPM)" title="Direct link to Swift packages (SwiftPM)">​</a></h4>
<p>An Xcode project can declare dependencies on Swift packages,
both remote and local.
The easy way to handle those dependencies with Bazel is by using <a href="https://github.com/cgrindel/rules_swift_package_manager" target="_blank" rel="noopener noreferrer"><strong>rules_swift_package_manager</strong></a>.</p>
<p><strong>rules_swift_package_manager</strong> requires all Swift package dependencies to be declared in a <code>Package.swift</code> file.
So any dependencies declared in an Xcode project need to be added to a new <code>Package.swift</code> file.
I say &quot;new&quot; since there might already exist <code>Package.swift</code> files that declare local packages,
and if you don&#x27;t want to migrate those packages to Bazel
(which we aren&#x27;t going to for this migration),
you&#x27;ll need to declare those packages as local dependencies in a new <code>Package.swift</code> file.<sup><a href="#user-content-fn-local-rspm-2fd3bf" id="user-content-fnref-local-rspm-2fd3bf" data-footnote-ref="true" aria-describedby="footnote-label">2</a></sup></p>
<p>Here is the new <code>Package.swift</code> file that includes the dependencies that were referenced in the Xcode project:</p>
<div class="language-swift codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">Package.swift</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-swift codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token comment" style="color:rgb(106, 153, 85)">// swift-tools-version:5.7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">PackageDescription</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">let</span><span class="token plain"> package </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Package</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Mastodon-iOS&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    defaultLocalization</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;en&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    platforms</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">iOS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">v16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    dependencies</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">package</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;ArkanaKeys&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;Dependencies/ArkanaKeys&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">package</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;MastodonSDK&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;MastodonSDK&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">package</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;https://github.com/Bearologics/LightChart.git&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            branch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;master&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">package</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;https://github.com/jdg/MBProgressHUD.git&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            from</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;1.2.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:rgb(220, 220, 170)">package</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;https://github.com/tid-kijyun/Kanna.git&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            from</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-literal string" style="color:rgb(206, 145, 120)">&quot;5.2.7&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Currently <strong>rules_swift_package_manager</strong> requires you to use <a href="https://github.com/bazelbuild/bazel-gazelle" target="_blank" rel="noopener noreferrer">Gazelle</a> in order to create a <code>swift_deps_index.json</code> file.<sup><a href="#user-content-fn-rspm-no-gazelle-2fd3bf" id="user-content-fnref-rspm-no-gazelle-2fd3bf" data-footnote-ref="true" aria-describedby="footnote-label">3</a></sup>
So we need to add a <code>bazel_dep</code> on <strong>gazelle</strong> in addition to <strong>rules_swift_package_manager</strong> in our <code>MODULE.bazel</code> file.
We also need to add a <a href="https://bazel.build/versions/7.0.0/rules/lib/globals/module#use_repo" target="_blank" rel="noopener noreferrer"><code>use_repo</code></a> stanza for the Swift packages we directly depend on
(though if you run the <code>//:swift_update_pkgs</code> Gazelle target,
which we will define shortly,
it will add the required stanza for you):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">MODULE.bazel</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">bazel_dep</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;rules_swift_package_manager&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;0.28.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">bazel_dep</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gazelle&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;0.35.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># swift_deps START</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">swift_deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> use_extension</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@rules_swift_package_manager//:extensions.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swift_deps&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">swift_deps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps_index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//:swift_deps_index.json&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">use_repo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    swift_deps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swiftpkg_arkanakeys&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swiftpkg_arkanakeysinterfaces&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swiftpkg_kanna&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swiftpkg_lightchart&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swiftpkg_mastodonsdk&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swiftpkg_mbprogresshud&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># swift_deps END</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And now we can define our Gazelle targets in a root <code>BUILD</code> file:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">BUILD</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@gazelle//:def.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gazelle&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gazelle_binary&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@rules_swift_package_manager//swiftpkg:defs.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">  </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swift_update_packages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># - Gazelle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Ignore the `.build` folder that is created by running Swift package manager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># commands. The Swift Gazelle plugin executes some Swift package manager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># commands to resolve external dependencies. This results in a `.build` file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># being created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># NOTE: Swift package manager is not used to build any of the external packages.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># The `.build` directory should be ignored. Be sure to configure your source</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># control to ignore it (i.e., add it to your `.gitignore`).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># gazelle:exclude .build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This declaration builds a Gazelle binary that incorporates all of the Gazelle</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># plugins for the languages that you use in your workspace. In this example, we</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># are only listing the Gazelle plugin for Swift from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># rules_swift_package_manager.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">gazelle_binary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gazelle_bin&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    languages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@rules_swift_package_manager//gazelle&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This macro defines two targets: `swift_update_pkgs` and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># `swift_update_pkgs_to_latest`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># The `swift_update_pkgs` target should be run whenever the list of external</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># dependencies is updated in the `Package.swift`. Running this target will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># populate the `swift_deps.bzl` with `swift_package` declarations for all of the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># direct and transitive Swift packages that your project uses.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># The `swift_update_pkgs_to_latest` target should be run when you want to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># update your Swift dependencies to their latest eligible version.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">swift_update_packages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swift_update_pkgs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    gazelle </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:gazelle_bin&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    generate_swift_deps_for_workspace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    patches_yaml </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;patches/swiftpkgs.yaml&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    update_bzlmod_stanzas </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># This target updates the Bazel build files for your project. Run this target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># whenever you add or remove source files from your project.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">gazelle</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;update_build_files&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    gazelle </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:gazelle_bin&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Because of how <strong>rules_apple</strong> handles app icon assets
(though possibly because of a bug),
we need to <a href="https://github.com/cgrindel/rules_swift_package_manager/blob/v0.28.0/docs/patch_swift_package.md" target="_blank" rel="noopener noreferrer">patch</a> the <strong>Tabman</strong> package to not include test assets.
Our patches are defined in the <code>patches/swiftpkgs.yaml</code> file.</p><p>Also,
in our <code>.bazelrc</code> file we added something to work around a <a href="https://github.com/cgrindel/rules_swift_package_manager/blob/v0.28.0/docs/faq.md#my-project-builds-successfully-with-bazel-build--but-it-does-not-build-when-using-rules_xcodeproj-how-can-i-fix-this" target="_blank" rel="noopener noreferrer">current issue</a> with <strong>rules_swift_package_manager</strong> and sandboxing.</p></div></div>
<p>To generate the <code>swift_deps_index.json</code> file,
and/or update the <code>MODULE.bazel</code> <code>use_repo</code> stanza,
run the <code>//:swift_update_pkgs</code> target:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">bazel run //:swift_update_pkgs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token output">INFO: Invocation ID: f2427bde-865b-43b3-bd3c-6a8489387f00</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Analyzed target //:swift_update_pkgs (148 packages loaded, 11707 targets configured).</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Found 1 target...</span><br></span><span class="token-line" style="color:#fff"><span class="token output">Target //:swift_update_pkgs up-to-date:</span><br></span><span class="token-line" style="color:#fff"><span class="token output">  bazel-bin/swift_update_pkgs-runner.bash</span><br></span><span class="token-line" style="color:#fff"><span class="token output">  bazel-bin/swift_update_pkgs</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Elapsed time: 1.724s, Critical Path: 0.07s</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: 1 process: 1 internal.</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Build completed successfully, 1 total action</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Running command line: bazel-bin/swift_update_pkgs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/9616360e2e7148ee5d6ceb63616d14b3363c2b51" target="_blank" rel="noopener noreferrer">this commit</a> Swift packages have been integrated for the Mastodon iOS project.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="app-extensions">App extensions<a href="#app-extensions" class="hash-link" aria-label="Direct link to App extensions" title="Direct link to App extensions">​</a></h4>
<p>App extensions,
such as the
<code>MastodonIntent</code>,
<code>NotificationService</code>,
<code>ShareActionExtension</code>,
<code>OpenInActionExtension</code>,
and <code>WidgetExtension</code>
targets,
are represented by a combination of an <a href="#ios_extension"><code>*_extension</code></a> and <a href="#swift_library">static library</a> rule.
And the static library target will need to have the <code>-application-extension</code> (for Swift) or <code>-fapplication-extension</code> (for Objective-C) copt set.</p>
<p>You will need to set the <code>infoplists</code> and <code>entitlements</code> attributes to your <code>Info.plist</code> and <code>.entitlements</code> files,
the <code>bundle_id</code> attribute to the value of the <code>PRODUCT_BUNDLE_IDENTIFIER</code> build setting,
and the <code>minimum_os_version</code> attribute to the value of <code>IPHONEOS_DEPLOYMENT_TARGET</code> build setting.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><strong>rules_apple</strong> processes <code>Info.plist</code> and <code>.entitlements</code> files in a slightly different manner than Xcode.
In Xcode,
you have build settings such as
<code>PRODUCT_BUNDLE_IDENTIFIER</code>,
<code>CURRENT_PROJECT_VERSION</code>,
and <code>PRODUCT_MODULE_NAME</code>.
And when it processes an <code>Info.plist</code>,
it substitutes references to those build settings with their resolved value.
<strong>rules_apple</strong> doesn&#x27;t use build settings,
so it&#x27;s not able to do the same substitutions.</p><p>There are some attributes on bundling rules that <strong>rules_apple</strong> <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/common_info.md#variable-substitution" target="_blank" rel="noopener noreferrer">will substitute</a> in place of a build setting,
such as <code>bundle_id</code> for <code>PRODUCT_BUNDLE_IDENTIFIER</code>,
but for the most part when using Bazel you&#x27;ll need to remove these build setting references from <code>Info.plist</code> and <code>.entitlements</code> files,
or use a custom rule to expand those values for you.
I decided to use the <strong>bazel_skylib</strong> <a href="https://github.com/bazelbuild/bazel-skylib/blob/1.5.0/docs/expand_template_doc.md" target="_blank" rel="noopener noreferrer"><code>expand_template</code></a> rule to allow the build setting references to stay in the <code>Info.plist</code> files.</p></div></div>
<p>Since the Mastodon iOS project doesn&#x27;t use resource bundles,
resources will be referenced directly with the <code>data</code> attribute of the static library target for the primary module.</p>
<p>With that in mind I added <code>BUILD</code> files for the app extension targets:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">WidgetExtension/BUILD</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@bazel_skylib//rules:expand_template.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;expand_template&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_apple//apple:ios.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ios_extension&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_apple//apple:resources.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;apple_intent_library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_swift//swift:swift.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swift_library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">ios_extension</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;WidgetExtension&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    bundle_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;org.joinmastodon.app.WidgetExtension&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    entitlements </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;WidgetExtension.entitlements&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    families </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ipad&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;iphone&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    infoplists </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:InfoPlist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    minimum_os_version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;16.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    resources </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> glob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;**/*.lproj/**&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;**/*.js&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;**/*.xcassets/**&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        exclude </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;.*&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    visibility </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//visibility:public&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:WidgetExtension.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">swift_library</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;WidgetExtension.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    srcs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> glob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;**/*.swift&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:WidgetExtension.intent&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    module_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;WidgetExtension&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@swiftpkg_lightchart//:LightChart&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@swiftpkg_mastodonsdk//:MastodonSDKDynamic&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">apple_intent_library</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;WidgetExtension.intent&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    src </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Base.lproj/WidgetExtension.intentdefinition&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    language </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Swift&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    visibility </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//visibility:public&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">expand_template</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;InfoPlist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    out </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Bazel.Info.plist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    substitutions </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;$(CURRENT_PROJECT_VERSION)&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;$(MARKETING_VERSION)&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;2024.3&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    template </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Info.plist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>We are using <a href="https://bazel.build/versions/7.0.0/reference/be/functions#glob" target="_blank" rel="noopener noreferrer"><code>glob</code></a> to collect our source files.
This requires that none of the source files in the workspace are dead/unused,
which can sometimes happen when using an Xcode project since it doesn&#x27;t have to reference all files in a directory.
It also requires that all source files for a module live under that module&#x27;s directory.
Best practice is to share code via modules instead of having multiple modules reference the same source file.</p><p>We also created and used an <a href="#apple_intent_library"><code>apple_intent_library</code></a> target for the <code>WidgetExtension.intentdefinition</code> file.
It has increased <a href="https://bazel.build/concepts/visibility" target="_blank" rel="noopener noreferrer">visibility</a> since it&#x27;s also used by the <code>Mastodon</code> application target.</p></div></div>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/4e615641e1028ee6cd7c7f9eb2a0148fa9cb68fb" target="_blank" rel="noopener noreferrer">this commit</a> app extensions have been translated for the Mastodon iOS project.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="applications">Applications<a href="#applications" class="hash-link" aria-label="Direct link to Applications" title="Direct link to Applications">​</a></h4>
<p>Applications,
such as the <code>Mastodon</code> target,
are represented by a combination of an <a href="#ios_application"><code>*_application</code></a> and <a href="#swift_library">static library</a> rule.
Since applications are bundle targets,
they are handled very similar to app extension targets,
which means we need to apply the same translations in regards to <code>Info.plist</code> files and build settings.</p>
<p>With that in mind I added a <code>BUILD</code> file for the <code>Mastodon</code> target:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">Mastodon/BUILD</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@bazel_skylib//rules:expand_template.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;expand_template&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_apple//apple:ios.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ios_application&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_swift//swift:swift.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swift_library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">ios_application</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Mastodon&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    bundle_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;org.joinmastodon.app&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    entitlements </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Mastodon.entitlements&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    extensions </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//MastodonIntent&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//NotificationService&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//OpenInActionExtension&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//ShareActionExtension&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//WidgetExtension&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    families </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ipad&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;iphone&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    infoplists </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:InfoPlist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    minimum_os_version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;16.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    resources </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> glob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Resources/**&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Supporting Files/**&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        exclude </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;.*&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Resources/Preview Assets.xcassets&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    visibility </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//visibility:public&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:Mastodon.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">swift_library</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Mastodon.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    srcs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> glob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;**/*.swift&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//MastodonIntent:Intents.intent&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//WidgetExtension:WidgetExtension.intent&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    module_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Mastodon&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    visibility </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//MastodonTests:__pkg__&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@swiftpkg_kanna//:Kanna&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@swiftpkg_mastodonsdk//:MastodonSDKDynamic&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@swiftpkg_mbprogresshud//:MBProgressHUD&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">expand_template</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;InfoPlist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    out </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Bazel.Info.plist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    substitutions </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;$(CURRENT_PROJECT_VERSION)&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;$(MARKETING_VERSION)&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;2024.3&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    template </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Info.plist&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The <a href="https://bazel.build/concepts/visibility" target="_blank" rel="noopener noreferrer">visibility</a> of the <code>Mastodon</code> target was increased to allow it to be a test host for tests.</p></div></div>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/dcf1dcd12f92b6d27719eea79c8fc7e2cf63df14" target="_blank" rel="noopener noreferrer">this commit</a> the iOS app has been translated for the Mastodon iOS project.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tests">Tests<a href="#tests" class="hash-link" aria-label="Direct link to Tests" title="Direct link to Tests">​</a></h4>
<p>Tests,
such as the <code>MastodonTests</code> and <code>MastodonUITests</code> targets,
are represented by a combination of a <a href="#ios_unit_test"><code>*_unit_test</code></a>/<a href="#ios_ui_test"><code>*_ui_test</code></a> and <a href="#swift_library">static library</a> rule.
Since tests are bundle targets,
they are handled very similar to application targets,
which means we need to apply the same translations in regards to <code>Info.plist</code> files and build settings.</p>
<p>If a unit test has a host application,
or a UI test has a target application,
the <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_unit_test-test_host" target="_blank" rel="noopener noreferrer"><code>test_host</code></a> attribute needs to be set to the corresponding <code>*_application</code> Bazel target.
In the case of unit tests,
if the <code>Allow testing Host Application APIs</code> checkbox is unchecked,
<a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_unit_test-test_host_is_bundle_loader" target="_blank" rel="noopener noreferrer"><code>test_host_is_bundle_loader</code></a> needs to be set to <code>False</code>.</p>
<p>With that in mind I added <code>BUILD</code> files for the <code>MastodonTests</code> and <code>MastodonUITests</code> targets:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">MastodonTests/BUILD</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_apple//apple:ios.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ios_unit_test&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_swift//swift:swift.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swift_library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">ios_unit_test</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;MastodonTests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    bundle_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;org.joinmastodon.MastodonTests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    minimum_os_version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;16.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    test_host </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//Mastodon:Mastodon&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:MastodonTests.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">swift_library</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;MastodonTests.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    srcs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> glob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;**/*.swift&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    module_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;MastodonTests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    testonly </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@swiftpkg_mastodonsdk//:MastodonSDKDynamic&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//Mastodon:Mastodon.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">MastodonUITests/BUILD</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_apple//apple:ios.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ios_ui_test&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@build_bazel_rules_swift//swift:swift.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;swift_library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">ios_ui_test</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;MastodonUITests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    bundle_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;org.joinmastodon.MastodonUITests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    minimum_os_version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;16.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    test_host </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//Mastodon:Mastodon&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    deps </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;:MastodonUITests.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">swift_library</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;MastodonUITests.library&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    srcs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> glob</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;**/*.swift&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    module_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;MastodonUITests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    testonly </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/f622f72b704b470650b3101aa7f0e2a5e8b2fdaf" target="_blank" rel="noopener noreferrer">this commit</a> the tests have been translated for the Mastodon iOS project.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="frameworks">Frameworks<a href="#frameworks" class="hash-link" aria-label="Direct link to Frameworks" title="Direct link to Frameworks">​</a></h4>
<p>Since we are using <strong>rules_swift_package_manager</strong> for the <code>MastodonSDK</code> target,
we don&#x27;t have any framework targets to define.
If we did though,
we would use the <a href="#ios_framework"><code>ios_framework</code></a> rule to define a bundle similar to our application or app extensions,
and reference the framework with the <a href="https://github.com/bazelbuild/rules_apple/blob/3.3.0/doc/rules-ios.md#ios_application-provisioning_profile" target="_blank" rel="noopener noreferrer"><code>frameworks</code></a> attribute.
This is in addition to listing dependencies in the <code>deps</code> attribute for any <a href="#swift_library">static library</a> targets that happen to be bundled in the framework.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="codegen">Codegen<a href="#codegen" class="hash-link" aria-label="Direct link to Codegen" title="Direct link to Codegen">​</a></h4>
<p>Bazel actions can&#x27;t modify source files in the workspace.
So in order to use code generation with Bazel you need to use a <a href="https://bazel.build/versions/7.0.0/reference/be/general#genrule" target="_blank" rel="noopener noreferrer"><code>genrule</code></a> or a custom rule to generate files,
which you then depend on in your <code>srcs</code> attributes.</p>
<p>The Mastodon iOS project uses <a href="https://github.com/krzysztofzablocki/Sourcery" target="_blank" rel="noopener noreferrer">Sourcery</a> and <a href="https://github.com/SwiftGen/SwiftGen" target="_blank" rel="noopener noreferrer">SwiftGen</a> to modify source files in-place,
which it then checks into source control.
In order to allow building the project with either xcodebuild or Bazel,
we will leave code generation as an external process.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="integrating-with-xcode">Integrating with Xcode<a href="#integrating-with-xcode" class="hash-link" aria-label="Direct link to Integrating with Xcode" title="Direct link to Integrating with Xcode">​</a></h2>
<p>If we were performing this migration more than a year ago this section would be a lot larger,
and could probably be its own post.
Thankfully since the start of last year we have a
fast,
stable,
and
mature
community backed solution in the form of <a href="https://github.com/MobileNativeFoundation/rules_xcodeproj" target="_blank" rel="noopener noreferrer"><strong>rules_xcodeproj</strong></a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="xcodeproj"><code>xcodeproj</code><a href="#xcodeproj" class="hash-link" aria-label="Direct link to xcodeproj" title="Direct link to xcodeproj">​</a></h3>
<p>To use <strong>rules_xcodeproj</strong>,
we add a <code>bazel_dep</code> for it to our <code>MODULE.bazel</code> file,
and define an <code>xcodeproj</code> target for the project in the root <code>BUILD</code> file:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">MODULE.bazel</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">bazel_dep</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;rules_xcodeproj&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1.16.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">BUILD</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;@rules_xcodeproj//xcodeproj:defs.bzl&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;top_level_target&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;xcodeproj&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">xcodeproj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;xcodeproj&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    generation_mode </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;incremental&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    project_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;MastodonBazel&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    top_level_targets </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        top_level_target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//Mastodon:Mastodon&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">            target_environments </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;simulator&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;device&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//MastodonTests:MastodonTests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;//MastodonUITests:MastodonUITests&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Any targets listed in <code>xcodeproj.top_level_targets</code> will need to grant visibility to <strong>rules_xcodeproj</strong>.
They can do so by having <code>&quot;@rules_xcodeproj//xcodeproj:generated&quot;</code> in their <a href="https://bazel.build/concepts/visibility" target="_blank" rel="noopener noreferrer"><code>visibility</code></a> attribute.</p></div></div>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/c0139c3cce3784832a00e42405c690a3db9c8d49" target="_blank" rel="noopener noreferrer">this commit</a> <strong>rules_xcodeproj</strong> has been integrated into the Mastodon iOS project.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="generating-the-xcode-project">Generating the Xcode project<a href="#generating-the-xcode-project" class="hash-link" aria-label="Direct link to Generating the Xcode project" title="Direct link to Generating the Xcode project">​</a></h3>
<p>We can now generate a Bazel integrated Xcode project by running a single command:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">bazel run //:xcodeproj</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token output">INFO: Analyzed target //:xcodeproj (1 packages loaded, 1 target configured).</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Found 1 target...</span><br></span><span class="token-line" style="color:#fff"><span class="token output">Target //:xcodeproj up-to-date:</span><br></span><span class="token-line" style="color:#fff"><span class="token output">  bazel-bin/xcodeproj-runner.sh</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Elapsed time: 0.089s, Critical Path: 0.00s</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: 3 processes: 3 internal.</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Build completed successfully, 3 total actions</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Running command line: bazel-bin/xcodeproj-runner.sh</span><br></span><span class="token-line" style="color:#fff"><span class="token output"></span><br></span><span class="token-line" style="color:#fff"><span class="token output">Generating &quot;MastodonBazel.xcodeproj&quot;</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Analyzed target @@rules_xcodeproj~1.16.0~internal~rules_xcodeproj_generated//generator/xcodeproj:xcodeproj (1 packages loaded, 1 target configured).</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Found 1 target...</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Elapsed time: 0.308s, Critical Path: 0.07s</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: 4 processes: 2 internal, 2 local.</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Build completed successfully, 4 total actions</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Running command line: /private/var/tmp/_bazel_brentley/b406c5544781724b8a84c3c6fa8dad13/rules_xcodeproj.noindex/build_output_base/execroot/_main/bazel-out/darwin_arm64-dbg/bin/external/rules_xcodeproj~1.16.0~internal~rules_xcodeproj_generated/generator/xcodeproj/xcodeproj-installer.sh --xcodeproj_bazelrc /private/var/tmp/_bazel_brentley/b406c5544781724b8a84c3c6fa8dad13/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/xcodeproj-runner.sh.runfiles/_main/xcodeproj.bazelrc --extra_flags_bazelrc /private/var/tmp/_bazel_brentley/b406c5544781724b8a84c3c6fa8dad13/execroot/_main/bazel-out/darwin_arm64-fastbuild/bin/xcodeproj-runner.sh.runfiles/_main/xcodeproj-extra-flags.bazelrc --bazel_path /Users/brentley/Library/Caches/bazelisk/downloads/sha256/93772ce53afbe2282d0d727137a19c835eaa6f328964d02024bf3c234993bf7b/bin/bazel --execution_root /private/var/tmp/_bazel_brentley/b406c5544781724b8a84c3c6fa8dad13/execroot/_main</span><br></span><span class="token-line" style="color:#fff"><span class="token output">Updated project at &quot;MastodonBazel.xcodeproj&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you open the generated project
(i.e. <code>xed MastodonBazel.xcodeproj</code>)
and run the <code>Mastodon</code> scheme,
it should
build,
install to the simulator,
and launch successfully:</p>
<p><img loading="lazy" src="/assets/images/mastodon-bazel-xcode-and-simulator-edbd4c56a1187b32e1b1f83b2288c8a4.png" width="3342" height="1614" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ensuring-bazel-sees-the-correct-xcode-version">Ensuring Bazel sees the correct Xcode version<a href="#ensuring-bazel-sees-the-correct-xcode-version" class="hash-link" aria-label="Direct link to Ensuring Bazel sees the correct Xcode version" title="Direct link to Ensuring Bazel sees the correct Xcode version">​</a></h3>
<p>Currently there are additional steps that need to be taken in order for Bazel to correctly detect when Xcode versions change.
I recommend reading the <a href="https://github.com/bazelbuild/rules_apple/blob/3.2.1/doc/common_info.md#xcode-version-selection-and-invalidation" target="_blank" rel="noopener noreferrer">&quot;Xcode Version Selection and Invalidation&quot;</a> section of the <strong>rules_apple</strong> docs for details on what and why.
If you only build your project inside of Xcode,
or with the <a href="https://github.com/MobileNativeFoundation/rules_xcodeproj/blob/1.17.0/docs/usage.md#command-line-api" target="_blank" rel="noopener noreferrer"><strong>rules_xcodeproj</strong> command-line API</a>,
there is nothing else you need to do to manage your Xcode version with Bazel,
because it <a href="https://github.com/MobileNativeFoundation/rules_xcodeproj/blob/1.17.0/xcodeproj/internal/templates/runner.sh#L148-L171" target="_blank" rel="noopener noreferrer">applies these steps for you</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="leveraging-remote-caching-and-remote-execution">Leveraging remote caching and remote execution<a href="#leveraging-remote-caching-and-remote-execution" class="hash-link" aria-label="Direct link to Leveraging remote caching and remote execution" title="Direct link to Leveraging remote caching and remote execution">​</a></h2>
<p>One of the main reasons to use Bazel,
instead of another build system such as xcodebuild,
is to leverage its remote caching and execution capabilities.
For a detailed overview on both of those capabilities,
I recommend reading my <a href="/blog/bazels-remote-caching-and-remote-execution-explained">post on the subject</a>.</p>
<p>For this post I&#x27;ll detail the steps I would take for any Bazel migration,
starting from no caching and ending with both caching and remote execution.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="disk-cache">Disk cache<a href="#disk-cache" class="hash-link" aria-label="Direct link to Disk cache" title="Direct link to Disk cache">​</a></h3>
<p>Bazel supports a form of &quot;remote cache&quot; that uses the local filesystem instead of a remote server.
It&#x27;s called the &quot;disk cache&quot; and is enabled with the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--disk_cache" target="_blank" rel="noopener noreferrer"><code>--disk_cache</code></a> flag.</p>
<p>There are pros and cons to using the disk cache:</p>
<ul>
<li><strong>Pros</strong>
<ul>
<li>Lower latency than a remote cache</li>
<li>Includes blobs<sup><a href="#user-content-fn-blob-2fd3bf" id="user-content-fnref-blob-2fd3bf" data-footnote-ref="true" aria-describedby="footnote-label">4</a></sup> that have been built locally,
which is useful for developers that can&#x27;t upload to the remote cache</li>
</ul>
</li>
<li><strong>Cons</strong>
<ul>
<li>Only includes blobs that have been built or downloaded for local builds</li>
<li>Some redundancy with blobs already stored in the output base</li>
<li>No automatic cleanup<sup><a href="#user-content-fn-disk-cache-max-size-2fd3bf" id="user-content-fnref-disk-cache-max-size-2fd3bf" data-footnote-ref="true" aria-describedby="footnote-label">5</a></sup></li>
<li>A history of being buggy</li>
</ul>
</li>
</ul>
<p>With those in mind,
we are going to start out by enabling the disk cache for all use cases in the <a href="https://bazel.build/run/bazelrc" target="_blank" rel="noopener noreferrer"><code>.bazelrc</code></a> file:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">.bazelrc</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token comment" style="color:rgb(106, 153, 85)"># Cache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--disk_cache</span><span class="token operator" style="color:rgb(212, 212, 212)">=~</span><span class="token plain">/bazel_disk_cache</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="remote-cache">Remote cache<a href="#remote-cache" class="hash-link" aria-label="Direct link to Remote cache" title="Direct link to Remote cache">​</a></h3>
<p>Using a remote cache allows for multiple machines to benefit from the work performed by a single machine.
It can be enabled with the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--remote_cache" target="_blank" rel="noopener noreferrer"><code>--remote_cache</code></a> flag.</p>
<p>The disk cache can be used concurrently with a remote cache,
but I only recommend that setup for local development.
That&#x27;s because normally the remote cache will only accept writes from CI,
so the disk cache can still provide a benefit to developers,
but CI will rarely see benefits,
and usually degradation,
by also using the disk cache.</p>
<p>We can adjust the <code>.bazelrc</code> file to
enable a remote cache,
disable uploads for local development,
and disable the disk cache on CI
(by using a dedicated <a href="https://bazel.build/run/bazelrc#config" target="_blank" rel="noopener noreferrer">config</a>):</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">.bazelrc</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">common </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--remote_cache</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">grpcs://remote.buildbuddy.io</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--noremote_upload_local_results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:upload </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--disk_cache</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:upload </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--remote_upload_local_results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># CI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:ci </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">upload</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We used <a href="https://www.buildbuddy.io/remote-cache" target="_blank" rel="noopener noreferrer">BuildBuddy&#x27;s Remote Cache</a> because it&#x27;s free for personal or open source projects.
We also used the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--remote_upload_local_results" target="_blank" rel="noopener noreferrer"><code>--[no]remote_upload_local_results</code></a> flag to control uploading to the remote cache,
but in your project you probably want to use some sort of authentication and authorization method to limit this instead
(e.g. <a href="https://www.buildbuddy.io/docs/guide-auth" target="_blank" rel="noopener noreferrer">BuildBuddy API keys</a>).</p>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/aeac0c76d4d94e227a8862e4d5f92953fd0bf173" target="_blank" rel="noopener noreferrer">this commit</a> a remote cache has been integrated into the Mastodon iOS project.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-cache-hits">Debugging cache hits<a href="#debugging-cache-hits" class="hash-link" aria-label="Direct link to Debugging cache hits" title="Direct link to Debugging cache hits">​</a></h3>
<p>There might be times when you get fewer cache hits than you are expecting.
If that&#x27;s the case,
I recommend reading <a href="https://bazel.build/remote/cache-remote" target="_blank" rel="noopener noreferrer">&quot;Debugging Remote Cache Hits&quot;</a> in the Bazel docs,
which has information that will aid you in finding the problem.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rules_xcodeproj-cache-warming"><strong>rules_xcodeproj</strong> cache warming<a href="#rules_xcodeproj-cache-warming" class="hash-link" aria-label="Direct link to rules_xcodeproj-cache-warming" title="Direct link to rules_xcodeproj-cache-warming">​</a></h3>
<p><strong>rules_xcodeproj</strong> most likely builds your targets with a slightly different configuration than when you build them on the command line.
Because of this,
<strong>rules_xcodeproj</strong> offers a <a href="https://github.com/MobileNativeFoundation/rules_xcodeproj/blob/1.17.0/docs/usage.md#command-line-api" target="_blank" rel="noopener noreferrer">command-line API</a> that allows you to build targets under the same configuration that it uses.
This allows us to build targets on CI in a way that will populate the remote cache with blobs that developers will then get cache hits on.</p>
<p>We can add a new config to the <code>.bazelrc</code> file to ensure that we don&#x27;t get CI specific modifications:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">.bazelrc</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token comment" style="color:rgb(106, 153, 85)"># Cache warming</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:warming </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">upload</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:warming </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--remote_download_minimal</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is the cache warming command we would run on CI:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">bazel run //:xcodeproj -- --generator_output_groups=all_targets &#x27;build --config=warming&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token output">INFO: Analyzed target //:xcodeproj (0 packages loaded, 0 targets configured).</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Found 1 target...</span><br></span><span class="token-line" style="color:#fff"><span class="token output">Target //:xcodeproj up-to-date:</span><br></span><span class="token-line" style="color:#fff"><span class="token output">  bazel-bin/xcodeproj-runner.sh</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Elapsed time: 0.145s, Critical Path: 0.00s</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: 1 process: 1 internal.</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Build completed successfully, 1 total action</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Running command line: bazel-bin/xcodeproj-runner.sh &#x27;--generator_output_groups=all_targets&#x27; &#x27;build --config=warming&#x27;</span><br></span><span class="token-line" style="color:#fff"><span class="token output"></span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Analyzed target @@rules_xcodeproj~override~internal~rules_xcodeproj_generated//generator/xcodeproj:xcodeproj (3 packages loaded, 515 targets configured).</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Found 1 target...</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Elapsed time: 4.002s, Critical Path: 3.48s</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: 13 processes: 5 internal, 7 local, 1 worker.</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Build completed successfully, 13 total actions</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p><code>--generator_output_groups=all_targets</code> will build every target,
in every <code>target_environment</code>,
that could be built by the project generated by <code>//:xcodeproj</code>.</p><p>If you don&#x27;t want to build <em>every</em> target
(e.g. you don&#x27;t want to cache tests or device builds),
you can adjust the
<code>top_level_targets</code>,
<code>focused_targets</code>,
and/or <code>unfocused_targets</code> attributes to reflect the subset of targets that you want to build.
You can do this by defining additional <code>xcodeproj</code> targets,
or by adjusting the existing <code>//:xcodeproj</code> target before running the cache warming command
(and then throwing away the modifications after).</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="build-event-service">Build event service<a href="#build-event-service" class="hash-link" aria-label="Direct link to Build event service" title="Direct link to Build event service">​</a></h3>
<p>Now that we have a remote cache enabled,
we should also enable uploading events to a Build Event Service (BES).
Using BES gives you greater insight into your builds,
asynchronously to when the build actually happened
(which can be immensely useful for CI builds).</p>
<p>Here are some benefits of using BES:</p>
<ul>
<li>Easily share build logs</li>
<li>See historical build data, including aggregations and trends</li>
<li>See details not exposed via the terminal
(e.g. all command-line flags used without having to use <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--announce_rc" target="_blank" rel="noopener noreferrer"><code>--announce_rc</code></a>,
or all environment variables set)</li>
<li>View action timing data (same as <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--generate_json_trace_profile" target="_blank" rel="noopener noreferrer"><code>--generate_json_trace_profile</code></a>)</li>
<li>Visualize queries</li>
<li>View error and test logs</li>
<li>Download action outputs</li>
<li>View remote cache stats</li>
<li>View related remote execution data<!-- -->
<ul>
<li>List of actions executed</li>
<li>Individual action details
(e.g. command-line arguments,
environment variables,
platform properties,
timing data,
and downloading inputs and outputs)</li>
</ul>
</li>
</ul>
<p>We can adjust the <code>.bazelrc</code> file to upload to a BES endpoint:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">.bazelrc</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token plain">common </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--bes_backend</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">grpcs://remote.buildbuddy.io</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--bes_results_url</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">https://app.buildbuddy.io/invocation/</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--bes_upload_mode</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">nowait_for_upload_complete</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We used <a href="https://www.buildbuddy.io/ui" target="_blank" rel="noopener noreferrer">BuildBuddy&#x27;s Build and Test UI</a> because it&#x27;s free for personal or open source projects.</p>
<p>Now when we perform a build there will be a <a href="https://app.buildbuddy.io/invocation/e69835b2-672f-4a4f-bb00-c73ca8850859" target="_blank" rel="noopener noreferrer">link to the build results UI</a>,
which when opened shows detailed information about the build performed:</p>
<div class="language-shellsession codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shellsession codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token command shell-symbol important" style="color:#FF5722;font-weight:bold">$</span><span class="token command"> </span><span class="token command bash language-bash">bazel build //Mastodon</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain"></span><span class="token output">INFO: Invocation ID: e69835b2-672f-4a4f-bb00-c73ca8850859</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Streaming build results to: https://app.buildbuddy.io/invocation/e69835b2-672f-4a4f-bb00-c73ca8850859</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Analyzed target //Mastodon:Mastodon (0 packages loaded, 0 targets configured).</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Found 1 target...</span><br></span><span class="token-line" style="color:#fff"><span class="token output">Target //Mastodon:Mastodon up-to-date:</span><br></span><span class="token-line" style="color:#fff"><span class="token output">  bazel-bin/Mastodon/Mastodon.ipa</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Elapsed time: 0.253s, Critical Path: 0.00s</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: 1 process: 1 internal.</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Build completed successfully, 1 total action</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO:</span><br></span><span class="token-line" style="color:#fff"><span class="token output">INFO: Streaming build results to: https://app.buildbuddy.io/invocation/e69835b2-672f-4a4f-bb00-c73ca8850859</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" src="/assets/images/mastodon-bazel-build-results-ui-ba79e24b22cd1f0300cc98853736ea94.png" width="2398" height="2276" class="img_ev3q"></p>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/aeac0c76d4d94e227a8862e4d5f92953fd0bf173" target="_blank" rel="noopener noreferrer">this commit</a> a BES endpoint has been integrated into the Mastodon iOS project.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="remote-execution">Remote execution<a href="#remote-execution" class="hash-link" aria-label="Direct link to Remote execution" title="Direct link to Remote execution">​</a></h3>
<p>Using a remote execution service allows Bazel to run actions on an external cluster of executors.
Because of the inherint latency involved in that
(e.g. network transfer and staging of remote input trees),
the remote executors need to be a fair bit faster than your local machine,
or your build needs to be &quot;wide enough&quot;,
for a remote build to be faster than a local one.</p>
<p>Enabling remote execution after you have remote caching set up is as simple as setting the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--remote_executor" target="_blank" rel="noopener noreferrer"><code>--remote_executor</code></a> flag
and ensuring that <code>remote</code> is the first strategy set in <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--spawn_strategy" target="_blank" rel="noopener noreferrer"><code>--spawn_strategy</code></a>.
(which it is by default).
You might also need to set some default platform properties with the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--remote_default_exec_properties" target="_blank" rel="noopener noreferrer"><code>--remote_default_exec_properties</code></a> flag to ensure that actions are routed to the right executors.</p>
<p>We can adjust the <code>.bazelrc</code> file to have a dedicated <code>remote</code> config which sets <code>--remote_executor</code> and some default platform properties for an Apple silicon Mac:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#fff;--prism-background-color:#212121"><div class="codeBlockTitle_Ktv7">.bazelrc</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#fff;background-color:#212121"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#fff"><span class="token comment" style="color:rgb(106, 153, 85)"># Remote exectuion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:remote </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">upload</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:remote </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--remote_executor</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">grpcs://remote.buildbuddy.io</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:remote </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--remote_default_exec_properties</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">OSFamily</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">darwin</span><br></span><span class="token-line" style="color:#fff"><span class="token plain">common:remote </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--remote_default_exec_properties</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">Arch</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">arm64</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>BuildBuddy&#x27;s anonymous and personal tiers don&#x27;t include Mac remote executors.
<a href="https://www.buildbuddy.io/contact" target="_blank" rel="noopener noreferrer">Contact us</a> if you want to use Mac remote execution.</p></div></div>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/ea98209d9907f03a89c7d08aef9ea0bfec729621" target="_blank" rel="noopener noreferrer">this commit</a> remote execution has been integrated into the Mastodon iOS project.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimizing">Optimizing<a href="#optimizing" class="hash-link" aria-label="Direct link to Optimizing" title="Direct link to Optimizing">​</a></h2>
<p>Now that everything is building,
and we have a functioning remote cache,
it&#x27;s time to optimize the build further.
Ideally we wouldn&#x27;t need to do anything further at this point,
but currently Bazel doesn&#x27;t have the best default settings for all projects.
And even if it did,
the structure of the build graph itself has a large impact on build performance.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimal-bazel-settings">Optimal Bazel settings<a href="#optimal-bazel-settings" class="hash-link" aria-label="Direct link to Optimal Bazel settings" title="Direct link to Optimal Bazel settings">​</a></h3>
<p>If you build with Xcode,
<strong>rules_xcodeproj</strong> will apply a lot of <a href="https://github.com/MobileNativeFoundation/rules_xcodeproj/blob/1.17.0/xcodeproj/internal/templates/xcodeproj.bazelrc" target="_blank" rel="noopener noreferrer">optimal settings for you</a>.
I&#x27;ll still list them here,
along with some settings it doesn&#x27;t set for you,
in case you need to build outside of Xcode.</p>
<p>At <a href="https://github.com/brentleyjones/mastodon-ios/commit/066830f4f2ee0a4c2f533ee26acfbe546f5b4bb2" target="_blank" rel="noopener noreferrer">this commit</a> we applied all of the flags discussed in the following sections to the Mastodon iOS project.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cacheability">Cacheability<a href="#cacheability" class="hash-link" aria-label="Direct link to Cacheability" title="Direct link to Cacheability">​</a></h4>
<p>The
<a href="https://github.com/bazelbuild/apple_support/blob/1.14.0/crosstool/cc_toolchain_config.bzl#L2080-L2089" target="_blank" rel="noopener noreferrer"><code>oso_prefix_is_pwd</code></a>,
<a href="https://github.com/bazelbuild/apple_support/blob/1.14.0/crosstool/cc_toolchain_config.bzl#L1747-L1761" target="_blank" rel="noopener noreferrer"><code>relative_ast_path</code></a>,
and <a href="https://github.com/bazelbuild/apple_support/blob/1.14.0/crosstool/cc_toolchain_config.bzl#L1851-L1873" target="_blank" rel="noopener noreferrer"><code>remap_xcode_path</code></a>
<a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--features" target="_blank" rel="noopener noreferrer">features</a> in <strong>apple_support</strong>,
and the <a href="https://github.com/bazelbuild/rules_swift/blob/1.16.0/swift/internal/feature_names.bzl#L229-L238" target="_blank" rel="noopener noreferrer"><code>swift.cacheable_swiftmodules</code></a> feature in <strong>rules_swift</strong>,
remove absolute paths from binaries produced by <strong>rules_apple</strong> and <strong>rules_swift</strong>.
It&#x27;s highly recommended that you use these features if using a remote cache,
otherwise you might get a low cache hit rate on anything involving those binaries.
As long as you are using a version of <strong>apple_support</strong> and <strong>rules_swift</strong> that is at least 1.5.0,
these features are enabled by default.
Otherwise,
you can enable them with <code>--features=oso_prefix_is_pwd,relative_ast_path,remap_xcode_path,swift.cacheable_swiftmodules</code>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>When using these features you may need to <a href="https://github.com/MobileNativeFoundation/rules_xcodeproj/blob/1.17.0/tools/generators/swift_debug_settings/src/Generator/WriteSwiftDebugSettings.swift#L121-L155" target="_blank" rel="noopener noreferrer">provide additional information to lldb</a> for debugging to work properly.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="local-performance">Local performance<a href="#local-performance" class="hash-link" aria-label="Direct link to Local performance" title="Direct link to Local performance">​</a></h4>
<p>Bazel&#x27;s implementation of <a href="https://bazel.build/docs/sandboxing" target="_blank" rel="noopener noreferrer">sandboxing</a> on macOS is slow.<sup><a href="#user-content-fn-slow-macos-sandbox-2fd3bf" id="user-content-fnref-slow-macos-sandbox-2fd3bf" data-footnote-ref="true" aria-describedby="footnote-label">6</a></sup>
Because of that I recommend,
at least for non-release builds,
disabling sandboxing.
This can be achieved by setting the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--spawn_strategy" target="_blank" rel="noopener noreferrer"><code>--spawn_strategy</code></a> flag to <code>remote,worker,local</code>,
and setting the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--worker_sandboxing" target="_blank" rel="noopener noreferrer"><code>--noworker_sandboxing</code></a> flag.</p>
<p>The <a href="https://github.com/bazelbuild/rules_swift/blob/1.16.0/swift/internal/feature_names.bzl#L167-L174" target="_blank" rel="noopener noreferrer"><code>swift.use_global_module_cache</code></a> feature in <strong>rules_swift</strong> sets the Swift module cache to a fixed location,
allowing it to be reused by multiple compilations.
This can result in up to 10 times faster compilations.
As long as you are using a version of <strong>rules_swift</strong> that is at least 1.5.0,
this feature is enabled by default.
Otherwise,
you can enable it with <code>--features=swift.use_global_module_cache</code>.</p>
<p>Bazel calculates digests of all input and output files,
in order to determine when actions need to be rerun.
By default it uses the <a href="https://en.wikipedia.org/wiki/SHA-2" target="_blank" rel="noopener noreferrer">SHA-256</a> hash function to calculate these digests.
Since version 6.4.0 Bazel now supports using the <a href="https://en.wikipedia.org/wiki/BLAKE_(hash_function)#BLAKE3" target="_blank" rel="noopener noreferrer">BLAKE3</a> hash function instead,
by setting the <a href="https://bazel.build/reference/command-line-reference#flag--digest_function" target="_blank" rel="noopener noreferrer"><code>--digest_function</code></a> startup flag to <code>blake3</code>.
For builds with large binaries,
which iOS apps usually have,
using BLAKE3 can result in up to 5 times faster digest calculations.
And since the actions producing these large binaries
(e.g. linking)
are normally on the critical path,
this can speed up incremental development.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If you use remote capabilities,
such as
remote caching,
remote execution,
or a build event service,
they also have to support the digest function you set with <code>--digest_function</code>.
In case you were wondering,
all of BuildBuddy&#x27;s products
(i.e. Build and Test UI, Remote Build Cache, and Remote Build Execution)
support BLAKE3 digests 😊.</p></div></div>
<p>Speaking of digests,
Bazel keeps an in-memory cache of file digests,
since computing the digests is expensive.
The default number of entries in this cache is set to 50,000,
which can be too low for some projects.
I recommend adjusting this up by setting the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--cache_computed_file_digests" target="_blank" rel="noopener noreferrer"><code>--cache_computed_file_digests</code></a> flag to <code>500000</code>.
This number seems to have a minimal impact on the amount of memory that the Bazel server retains.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="remote-performance">Remote performance<a href="#remote-performance" class="hash-link" aria-label="Direct link to Remote performance" title="Direct link to Remote performance">​</a></h4>
<p>There are a few settings I recommend adjusting for optimal
remote caching,
remote execution,
and build event service
usage.</p>
<p>The <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--experimental_remote_cache_async" target="_blank" rel="noopener noreferrer"><code>--experimental_remote_cache_async</code></a> flag allows execution of actions that don&#x27;t depend on the output of a given action to start before the outputs of that action finish uploading.
That&#x27;s a lot of words to say that uploading of outputs becomes as asynchronous as possible,
while still blocking dependent actions from starting.
The <code>bazel</code> command will also block at the end of a build while it waits for all uploads to finish.</p>
<p>Similarly,
setting the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--bes_upload_mode" target="_blank" rel="noopener noreferrer"><code>--bes_upload_mode</code></a> flag to <code>nowait_for_upload_complete</code> will prevent the <code>bazel</code> command from blocking at the end of a build while it uploads to a build event service.
If another build starts while uploads are still happening in the background,
that build will wait to start until the previous uploads finish.
You can have previous uploads cancelled rather than delay a build by using a value of <code>fully_async</code> instead.</p>
<p>Speaking of BES related flags,
if your build event service isn&#x27;t <a href="https://github.com/google/resultstoreui" target="_blank" rel="noopener noreferrer">ResultStore</a>
(e.g. BuildBuddy),
you should set <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--legacy_important_outputs" target="_blank" rel="noopener noreferrer"><code>--nolegacy_important_outputs</code></a> to reduce the size of the uploaded events.</p>
<p>The <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--remote_cache_compression" target="_blank" rel="noopener noreferrer"><code>--remote_cache_compression</code></a> flag causes Bazel to compress uploads and decompress downloads with the <a href="https://github.com/facebook/zstd" target="_blank" rel="noopener noreferrer">zstd</a> algorithm.
This reduces the average number of bytes transferred by around 70%,
which for some projects has resulted in a 45% faster overall build time.</p>
<p>Some types of actions we shouldn&#x27;t remotely cache or build.
We can tell Bazel about that by using the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--modify_execution_info" target="_blank" rel="noopener noreferrer"><code>--modify_execution_info</code></a> flag.
The <strong>rules_apple</strong> documentation has a <a href="https://github.com/bazelbuild/rules_apple/blob/master/doc/common_info.md#optimizing-remote-cache-and-build-execution-performance" target="_blank" rel="noopener noreferrer">nice explaination</a> on the suggested value for this flag.</p>
<p>If using remote execution,
you might have to set some additional platform properties for optimal performance.
In the case of BuildBudddy&#x27;s product,
I recommend setting <a href="https://www.buildbuddy.io/docs/rbe-platforms#action-isolation-and-hermeticity-properties" target="_blank" rel="noopener noreferrer">these properties</a>:</p>
<ul>
<li><code>recycle-runner=true</code></li>
<li><code>preserve-workspace=true</code></li>
<li><code>clean-workspace-inputs=*</code></li>
</ul>
<p>Finally,
when using remote caching or remote execution,
you&#x27;ll want to use an increased value for the <a href="https://bazel.build/versions/7.0.0/reference/command-line-reference#flag--jobs" target="_blank" rel="noopener noreferrer"><code>--jobs</code></a> flag.
A higher value will result in more concurrent downloads and/or remote actions being executed.
You&#x27;ll need to experiement to determine the correct value for you,
since different projects or host machines can benefit from,
or potentially suffer from<sup><a href="#user-content-fn-jobs-flag-performance-2fd3bf" id="user-content-fnref-jobs-flag-performance-2fd3bf" data-footnote-ref="true" aria-describedby="footnote-label">7</a></sup>,
different values.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="modularization">Modularization<a href="#modularization" class="hash-link" aria-label="Direct link to Modularization" title="Direct link to Modularization">​</a></h3>
<p>To get the most benefit out of Bazel&#x27;s incremental compilation support,
you need to have your project split into many modules.
If your project is only a couple large modules,
then when you make changes most of that code will need to be recompiled.
But if your project is made up of many small modules,
then when you make changes a smaller portion of the code will need to be recompiled.</p>
<p>You can think of modularization
(the process of splitting large modules into smaller modules)
as one way to optimize your build graph for Bazel.
Another would be adjusting your dependencies such that your build graph is &quot;wide&quot; instead of &quot;deep&quot;.
This allows for more parallel compilation,
and when using <a href="#remote-execution">remote execution</a> the wider the build graph is the better.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="next-steps">Next steps<a href="#next-steps" class="hash-link" aria-label="Direct link to Next steps" title="Direct link to Next steps">​</a></h2>
<p>At this point you should have a well functioning iOS Bazel project.
Congratulations 🎉!</p>
<p>Next steps from here depend on what is the highest priority for you and your team.
You could
continue focusing on modularization,
profile and optimize build performance,
or maybe look into custom macros and rules to make your specific workflows more efficient or easier to set up.</p>
<p>In you need any help,
the <code>#apple</code> and <code>#rules_xcodeproj</code> channels in the <a href="https://slack.bazel.build/" target="_blank" rel="noopener noreferrer">Bazel Slack workspace</a> are a great place to ask questions.
You can also email us at <a href="mailto:hello@buildbuddy.io" target="_blank" rel="noopener noreferrer">hello@buildbuddy.io</a> with any questions, comments, or thoughts.</p>
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_LWe7 sr-only" id="footnote-label">Footnotes<a href="#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">​</a></h2>
<ol>
<li id="user-content-fn-mergable_libraries-2fd3bf">
<p>When <strong>rules_apple</strong> gains support for <a href="https://github.com/bazelbuild/rules_apple/issues/1988" target="_blank" rel="noopener noreferrer">mergable_libraries</a> this type of workflow will be a lot easier to support. <a href="#user-content-fnref-mergable_libraries-2fd3bf" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-local-rspm-2fd3bf">
<p>This is an area that I think can be improved upon in <strong>rules_swift_package_manager</strong>.
For example,
if you are only using a <code>Package.swift</code> file,
without an Xcode project,
I think it would be nice to be able to use <strong>rules_swift_package_manager</strong> to build the declared products in it,
without having to migrate those to Bazel manually. <a href="#user-content-fnref-local-rspm-2fd3bf" data-footnote-backref="" aria-label="Back to reference 2" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-rspm-no-gazelle-2fd3bf">
<p>There is <a href="https://github.com/cgrindel/rules_swift_package_manager/discussions/936" target="_blank" rel="noopener noreferrer">a plan</a> that before <strong>rules_swift_package_manager</strong> reaches 1.0.0 it will remove the need for the <code>swift_deps_index.json</code> file,
and the need to use Gazelle with it. <a href="#user-content-fnref-rspm-no-gazelle-2fd3bf" data-footnote-backref="" aria-label="Back to reference 3" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-blob-2fd3bf">
<p>A &quot;blob&quot; is an <a href="https://github.com/bazelbuild/remote-apis" target="_blank" rel="noopener noreferrer">REAPI</a> term for artifacts that are stored in a cache. <a href="#user-content-fnref-blob-2fd3bf" data-footnote-backref="" aria-label="Back to reference 4" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-disk-cache-max-size-2fd3bf">
<p><a href="https://github.com/bazelbuild/bazel/issues/5139" target="_blank" rel="noopener noreferrer">Bazel issue #5139</a>. <a href="#user-content-fnref-disk-cache-max-size-2fd3bf" data-footnote-backref="" aria-label="Back to reference 5" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-slow-macos-sandbox-2fd3bf">
<p><a href="https://github.com/bazelbuild/bazel/issues/8230" target="_blank" rel="noopener noreferrer">Bazel issue #8320</a>. <a href="#user-content-fnref-slow-macos-sandbox-2fd3bf" data-footnote-backref="" aria-label="Back to reference 6" class="data-footnote-backref">↩</a></p>
</li>
<li id="user-content-fn-jobs-flag-performance-2fd3bf">
<p><a href="https://github.com/bazelbuild/bazel/issues/21594" target="_blank" rel="noopener noreferrer">Bazel issue #21954</a>. <a href="#user-content-fnref-jobs-flag-performance-2fd3bf" data-footnote-backref="" aria-label="Back to reference 7" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section></div><footer class="row margin-vert--lg"><div class="tags_OHNp"><strong>Tags:</strong><a class="tag_p3At" href="/blog/tags/bazel">bazel</a></div></footer></article><div><a href="https://github.com/buildbuddy-io/buildbuddy/edit/master/website/blog/how-to-migrate-an-ios-app-to-bazel.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/how-bazel-7-0-makes-your-builds-faster"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">How Bazel 7.0 Makes Your Builds Faster</div></a></nav></div></main><div class="col col--1"></div><div class="col col--3"><div class="blog-sidebar"><div class="sidebar_ycyQ thin-scrollbar"><h3 class="sidebarItemTitle_uR5j">Recent posts</h3><ul class="sidebarItemList_TpH3"><li class="sidebarItem_WWBq"><a aria-current="page" class="sidebarItemLink_Hhz8 sidebarItemLinkActive_OkT7" href="/blog/how-to-migrate-an-ios-app-to-bazel">How to migrate an iOS app to Bazel</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/how-bazel-7-0-makes-your-builds-faster">How Bazel 7.0 Makes Your Builds Faster</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/whats-new-in-bazel-7-0">What&#x27;s New in Bazel 7.0</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/image-streaming">Lazily Pulling Container Images with Podman and SOCI Snapshotter</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/bazelcon-2023">Bazelcon 2023 Recap</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/redpoint-infrared-100">BuildBuddy Named to Inaugural Redpoint InfraRed 100</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/postgres-support">PostgreSQL Support for BuildBuddy</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/customer-managed-encryption-keys">Providing Control Over Cache Encryption</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/buck2-review">Buck2 Unboxing</a></li><li class="sidebarItem_WWBq"><a class="sidebarItemLink_Hhz8" href="/blog/keyboard-shortcuts">Keyboard Shortcuts in BuildBuddy</a></li></ul></div></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="/"><img alt="BuildBuddy Logo" src="/img/logo_white.svg" width="281px" height="32px" class="footer-logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/ui">Build &amp; Test UI</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/remote-execution">Remote Execution</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/remote-cache">Remote Cache</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/workflows">Workflows</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/cli">CLI</a></li><li class="footer__item"><a href="https://app.buildbuddy.io" target="_self" rel="noopener noreferrer" class="footer__link-item">Get Started<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://app.buildbuddy.io/" target="_self" rel="noopener noreferrer" class="footer__link-item">Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/introduction/">Docs</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/pricing">Pricing</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/security">Security</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/plugins">Plugins</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/enterprise-api">API</a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/contact">Contact Us</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/team">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/careers">Careers</a></li><li class="footer__item"><a href="https://github.com/buildbuddy-io/buildbuddy/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item">Report an Issue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/privacy">Privacy Policy</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/terms">Terms of Service</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="http://community.buildbuddy.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/buildbuddy_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="http://linkedin.com/company/buildbuddy" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/buildbuddy-io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2024 Iteration, Inc.</div></div></div></footer></div>
</body>
</html>