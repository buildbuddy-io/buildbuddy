actions:
  - name: Test
    container_image: ubuntu-22.04
    resource_requests:
      disk: 27GB
    triggers:
      push:
        branches:
          - "master"
          - "bb_release_*"
      pull_request:
        branches:
          - "*"
    steps:
      - run: "bazel test //... --config=linux-workflows --config=race --test_tag_filters=-performance,-bare"
  - name: Test internal repo
    container_image: ubuntu-22.04
    triggers:
      push:
        branches:
          - "master"
      pull_request:
        branches:
          - "*"
    visibility: PRIVATE
    steps:
      # Clone buildbuddy-internal repo
      # TODO: create some sort of "checkout" util to easily clone
      # multiple repos?
      - run: |
          cd ..
          if ! [[ -e buildbuddy-internal ]]; then
            git clone https://github.com/buildbuddy-io/buildbuddy-internal --filter=blob:none
          fi
          cd buildbuddy-internal
          git clean -fdx
          git pull
      # Test all targets from the internal repo, pointing bazel at the currently
      # checked out commit of the OSS repo. Use --config=workflows to get
      # caching+RBE, but override the remote instance name so we can share the
      # cache with the other Test workflow.
      - run: |
          cd ../buildbuddy-internal
          bazel test //... \
            --override_repository=+_repo_rules+com_github_buildbuddy_io_buildbuddy=../repo-root \
            --config=workflows \
            --remote_instance_name=buildbuddy-io/buildbuddy/workflows
  - name: Check style
    container_image: ubuntu-22.04
    triggers:
      push:
        branches:
          - "master"
      pull_request:
        branches:
          - "*"
    # Do a non-shallow fetch so that we can diff against the previous commit
    # when running on push to master.
    git_fetch_depth: 0
    steps:
      - run: "bazel run //tools/lint --config=linux-workflows"
  - name: Test (darwin_amd64)
    os: "darwin"
    triggers:
      push:
        branches:
          - "master"
      pull_request:
        branches:
          - "*"
    # TODO: Fix the tests below on Mac, and re-enable.
    steps:
      - run: >-
          bazel test --config=mac-workflows --test_tag_filters=-performance,-webdriver,-docker,-bare
          --
          //...
          -//server/backends/disk_cache:all
          -//server/test/integration/remote_asset:all
          -//enterprise/server/backends/pebble_cache:all
          -//enterprise/server/raft/txn:all
          -//enterprise/server/raft/store:all
          -//enterprise/server/remote_execution/commandutil:all
          -//enterprise/server/remote_execution/runner:all
          -//enterprise/server/test/integration/...
  - name: Test (darwin_arm64)
    os: "darwin"
    arch: "arm64"
    triggers:
      push:
        branches:
          - "master"
      pull_request:
        branches:
          - "*"
    # TODO: Fix the tests below on Mac, and re-enable.
    steps:
      - run: >-
          bazel test --config=mac-workflows --test_tag_filters=-performance,-webdriver,-docker,-bare
          --
          //...
          -//server/backends/disk_cache:all
          -//server/test/integration/remote_asset:all
          -//enterprise/server/backends/pebble_cache:all
          -//enterprise/server/raft/txn:all
          -//enterprise/server/raft/store:all
          -//enterprise/server/remote_execution/commandutil:all
          -//enterprise/server/remote_execution/runner:all
          -//enterprise/server/test/integration/...
  - name: Benchmark
    container_image: ubuntu-22.04
    triggers:
      push:
        branches:
          - "master"
    steps:
      - run: "bazel test //... --config=linux-workflows --config=performance --test_tag_filters=+performance"
  - name: Baremetal tests
    container_image: ubuntu-22.04
    triggers:
      push:
        branches:
          - "master"
      pull_request:
        branches:
          - "*"
    steps:
      - run: "bazel test //... --config=linux-workflows --config=race --test_tag_filters=+bare --build_tag_filters=+bare"

plugins:
  - path: cli/plugins/go-deps
  - path: cli/plugins/open-invocation
  - path: cli/plugins/notify
  - path: cli/example_plugins/go-highlight
