syntax = "proto3";

package vmexec;

import "proto/remote_execution.proto";

message FileSystemLayout {
  // The "remote instance name" to use when interacting with the CAS.
  string remote_instance_name = 1;
  // The layout of the inputs to the command to be executed.
  build.bazel.remote.execution.v2.Tree inputs = 2;
}

message CASFSConfiguration {
  // Description of the filesystem layout.
  FileSystemLayout file_system_layout = 1;
  // Whether to prepare the filesystem, but skip the execution.
  bool debug_skip_execute = 2;
}

message ExecRequest {
  string working_directory = 1;

  message EnvironmentVariable {
    // The variable name.
    string name = 1;

    // The variable value.
    string value = 2;
  }

  // The environment variables to set when running the program.
  repeated EnvironmentVariable environment_variables = 2;

  // The arguments to the command. The first argument must be the path to the
  // executable.
  repeated string arguments = 3;

  // Optional. Ports are vsock ports where the host will read/write stdin,
  // stdout, and stderr. If unset, or set to 0, input will be ignored and
  // output will be buffered and returned in the ExecResponse.
  int32 stdin_vsock_port = 4;
  int32 stdout_vsock_port = 5;
  int32 stderr_vsock_port = 6;

  // Optional. Used to configure the CASFS filesystem on the VM.
  CASFSConfiguration casfs_configuration = 7;
}

message ExecResponse {
  int32 exit_code = 1;
  bytes stdout = 2;
  bytes stderr = 3;
}

// This service is run inside of a VM. It executes commands sent to it over
// gRPC in the local environment and returns the results.
service Exec {
  rpc Exec(ExecRequest) returns (ExecResponse);
}
