"use strict";(self.webpackChunkbuildbuddy_docs_website=self.webpackChunkbuildbuddy_docs_website||[]).push([[4316],{59371:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var i=n(6951),s=n(74848),o=n(28453);const a={slug:"bisect-bazel",title:"Troubleshooting Bazel with Git Bisect",description:"A guide to using Git bisect to troubleshoot Bazel issues",authors:"son",date:"2025-02-18:12:00:00",image:"/img/blog/troubleshooting.png",tags:["bazel","git","engineering"]},l=void 0,r={authorsImageUrls:[void 0]},c=[{value:"Build failed after upgrading Bazel",id:"build-failed-after-upgrading-bazel",level:2},{value:"Auto-bisect with bazelisk",id:"auto-bisect-with-bazelisk",level:4},{value:"Manual bisect with git-bisect",id:"manual-bisect-with-git-bisect",level:4},{value:"Build failed after upgrading a dependency",id:"build-failed-after-upgrading-a-dependency",level:2},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const t={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h4:"h4",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"Upgrading Bazel and the related dependencies can sometimes lead to unexpected issues.\nThese issues can range from build failures to runtime errors, and generally, they can be hard to troubleshoot."}),"\n",(0,s.jsxs)(t.p,{children:["So today, we will discuss how to narrow down the root cause of build failures after a dependency upgrade using ",(0,s.jsx)(t.code,{children:"git bisect"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"build-failed-after-upgrading-bazel",children:"Build failed after upgrading Bazel"}),"\n",(0,s.jsxs)(t.p,{children:["If you are like me, you would enjoy having the latest and greatest tools in your project.\nAnd the tool I use the most is Bazel, so as the recent ",(0,s.jsx)(t.code,{children:"8.1.0"})," release came out, I decided to upgrade our BuildBuddy repository to use it."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ echo '8.1.0' > .bazelversion\n\n$ bazel test --config=remote-minimal //...\n...\nERROR: /root/workspace/output-base/external/bazel_tools/tools/build_defs/repo/http.bzl:137:45: An error occurred during the fetch of repository 'rules_cc+':\n   Traceback (most recent call last):\n        File \"/root/workspace/output-base/external/bazel_tools/tools/build_defs/repo/http.bzl\", line 137, column 45, in _http_archive_impl\n                download_info = ctx.download_and_extract(\nError in download_and_extract: com.google.devtools.build.lib.remote.common.CacheNotFoundException: Missing digest: abc605dd850f813bb37004b77db20106a19311a96b2da1c92b789da529d28fe1/178823\n...\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Whoops! It seems like the build failed after upgrading Bazel to ",(0,s.jsx)(t.code,{children:"8.1.0"}),".\nFlipping back to ",(0,s.jsx)(t.code,{children:"8.0.1"})," made the problem go away, which means the issue was introduced in Bazel ",(0,s.jsx)(t.code,{children:"8.1.0"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"What should we do next?"}),"\n",(0,s.jsx)(t.h4,{id:"auto-bisect-with-bazelisk",children:"Auto-bisect with bazelisk"}),"\n",(0,s.jsxs)(t.p,{children:["Luckily, the Bazel team has provided us with a magic flag inside ",(0,s.jsx)(t.code,{children:"bazelisk"})," that can help us with this."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://github.com/bazelbuild/bazelisk?tab=readme-ov-file#--bisect",children:"--bisect"})," flag automatically lists the commits between the two Bazel releases and helps us bisect them.\nIt works like this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"alias bazel=bazelisk\n\n# Usage:\n#   bazelisk --bisect=<good commit hash>..<bad commit hash> test //foo:bar_test\n$ BAZELISK_CLEAN=1 bazelisk --bisect=8.0.1..8.1.0 test --config=remote-minimal //...\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Explanation"}),": The last-known good release for us was ",(0,s.jsx)(t.code,{children:"8.0.1"}),", and the bad release was ",(0,s.jsx)(t.code,{children:"8.1.0"}),". Bazelisk will grab the list of commits between 2 versions from the Github API and start a bisect. For each bisect commit, it will grab a pre-built Bazel binary of that version from a Google Cloud Storage bucket and run the test command accordingly. The ",(0,s.jsx)(t.code,{children:".bazelversion"})," file will be ignored in these runs."]}),"\n",(0,s.jsxs)(t.p,{children:["Because the issue was related to external dependencies download, we set ",(0,s.jsx)(t.code,{children:"BAZELISK_CLEAN=1"})," for the whole Bazelisk bisect process.\nThis will add ",(0,s.jsx)(t.code,{children:"bazel clean --expunge"})," in between each test run, effectively cleaning Bazel's output base and shutting down the Bazel JVM process, to make sure we reproduce the issue in a mint environment.\nYou can check out other environment variables that Bazelisk supports ",(0,s.jsx)(t.a,{href:"https://github.com/bazelbuild/bazelisk/blob/740e1b91b5b2e86730b6bb12aaf211fc19f388a5/README.md?plain=1#L162",children:"here"})]}),"\n",(0,s.jsxs)(t.p,{children:["Since we know that the issue was caused by the external download of ",(0,s.jsx)(t.code,{children:"@rules_cc"}),", we can narrow down the test command to a ",(0,s.jsx)(t.code,{children:"bazel query"})," that would still trigger the same download. This should help speed up each bisect run and reduce the chance of flakiness."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ BAZELISK_CLEAN=1 bazelisk --bisect=8.0.1..8.1.0 query --config=remote-minimal @rules_cc//:all\n"})}),"\n",(0,s.jsx)(t.p,{children:"And here is the result:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"--- Getting the list of commits between 8.0.1 and 8.1.0\nFound 95 commits between (24cba660a7231786405ac40335c2e7e5bd4d6859, 8.1.0]\n--- Verifying if the given good Bazel commit (24cba660a7231786405ac40335c2e7e5bd4d6859) is actually good\n--- Start bisecting\n--- Testing with Bazel built at c5cf63199b3964b4a188da73a6c24599468131e9, 95 commits remaining...\n--- Succeeded at c5cf63199b3964b4a188da73a6c24599468131e9\n--- Testing with Bazel built at 040769767613287a0f1b5ceed41b9d7729126983, 47 commits remaining...\n\n2025/02/18 10:56:29 Using unreleased version at commit 040769767613287a0f1b5ceed41b9d7729126983\n2025/02/18 10:56:29 Downloading https://storage.googleapis.com/bazel-builds/artifacts/macos_arm64/040769767613287a0f1b5ceed41b9d7729126983/bazel...\n2025/02/18 10:56:29 Skipping basic authentication for storage.googleapis.com because no credentials found in /Users/sluongng/.netrc\n2025/02/18 10:56:29 could not run Bazel: could not download Bazel: failed to download bazel: failed to download bazel: HTTP GET https://storage.googleapis.com/bazel-builds/artifacts/macos_arm64/040769767613287a0f1b5ceed41b9d7729126983/bazel failed with error 404\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Here, Bazelisk was able to identify ",(0,s.jsx)(t.code,{children:"8.0.1"})," to be ",(0,s.jsx)(t.code,{children:"24cba660a"})," and verified that it was indeed a good commit. It then started bisecting the commits between ",(0,s.jsx)(t.code,{children:"24cba660a"})," and ",(0,s.jsx)(t.code,{children:"8.1.0"}),". The first bisect commit ",(0,s.jsx)(t.code,{children:"c5cf63199b"})," was good. However, the second bisect commit ",(0,s.jsx)(t.code,{children:"0407697676"})," failed to download the Bazel binary from the Google Cloud Storage (GCS) bucket. This is a different failure than the original issue we are investigating, so how do we proceed?"]}),"\n",(0,s.jsx)(t.h4,{id:"manual-bisect-with-git-bisect",children:"Manual bisect with git-bisect"}),"\n",(0,s.jsxs)(t.p,{children:['If Bazelisk had a flag to help us mark a few known commits as "SKIP", it would have been perfect here, but unfortunately, it doesn\'t. But I know for a fact that ',(0,s.jsx)(t.code,{children:"git bisect"})," does have this feature, so let's switch to manual bisecting."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"# My personal working directory\n$ cd ~/work/bazelbuild/\n\n# Clone the Bazel repository\n$ git clone https://github.com/bazelbuild/bazel.git\n$ cd bazel\n\n# Start bisecting\n$ git bisect start --no-checkout --first-parent 8.1.0 8.0.1\nBisecting: 47 revisions left to test after this (roughly 6 steps)\n[8afe16e0396be93cc5d9bc2108aab2e45dfcb2bd] [8.1.0] Fix docs link rewriting for rules_android (#25018)\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Note that thanks to the pre-built binaries from the GCS bucket managed by the Bazel team, we don't need to build Bazel ourselves. Because of this, we can use the ",(0,s.jsx)(t.code,{children:"--no-checkout"})," flag to speed up the bisect process. When ",(0,s.jsx)(t.code,{children:"--no-checkout"})," is used, the current bisect commit could be found in ",(0,s.jsx)(t.code,{children:".git/BISECT_HEAD"})," file.\n",(0,s.jsx)(t.code,{children:"--first-parent"})," forces the bisect to only follow the first parent of the commit, which is usually all the merge commits in the ",(0,s.jsx)(t.code,{children:"master/main"})," branch of each repo.\nThankfully, the ",(0,s.jsx)(t.code,{children:"bazel.git"})," repo history is very linear so ",(0,s.jsx)(t.code,{children:"--first-parent"})," is not really needed here, but I will keep the flag in to help the readers (including my future self) copy pasting easier."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ cat .git/BISECT_HEAD\n8afe16e0396be93cc5d9bc2108aab2e45dfcb2bd\n"})}),"\n",(0,s.jsxs)(t.p,{children:["So how do we tell Bazelisk to use a pre-built binary from the GCS bucket that belongs to this commit? Luckily, we can set the environment variable ",(0,s.jsx)(t.code,{children:"USE_BAZEL_VERSION"})," for this exact reason."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ USE_BAZEL_VERSION=7.1.0 bazel version\nversion\nBazelisk version: 1.25.0\nExtracting Bazel installation...\nBuild label: 7.1.0\nBuild target: @@//src/main/java/com/google/devtools/build/lib/bazel:BazelServer\nBuild time: Mon Mar 11 17:55:51 2024 (1710179751)\nBuild timestamp: 1710179751\nBuild timestamp as int: 1710179751\n"})}),"\n",(0,s.jsxs)(t.p,{children:["With this, we can manually alternate between the 2 directories ",(0,s.jsx)(t.code,{children:"~/work/bazelbuild/bazel"})," and ",(0,s.jsx)(t.code,{children:"~/work/buildbuddy-io/buildbuddy"})," to run the test command and mark the commit as good or bad."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"# Copy the new bisect commit to the clipboard\n$ export USE_BAZEL_VERSION=$(cat .git/BISECT_HEAD)\n\n# Verify the commit\n$ cd ~/work/buildbuddy-io/buildbuddy\n$ bazel ... query ...\n...\n\n$ cd ~/work/bazelbuild/bazel\n# $ git bisect good\n# $ git bisect bad\n# $ git bisect skip\n\n# Repeat\n"})}),"\n",(0,s.jsxs)(t.p,{children:["However, that would not make for a really good blog post.\nSo let's be a bit more fancy and create a script to help us automate this bisect process using ",(0,s.jsx)(t.code,{children:"git bisect run"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ cat test-buildbuddy.sh\n#!/bin/bash\n\nexport USE_BAZEL_VERSION='8.0.1'\n# export USE_BAZEL_VERSION=$(cat .git/BISECT_HEAD)\n\nfunction cleanup()\n{\n  (\n    cd ~/work/buildbuddy-io/buildbuddy\n    bazel clean --expunge\n  )\n}\ntrap cleanup EXIT\n\n(\n  cd ~/work/buildbuddy-io/buildbuddy\n  STDERROUT=$(bazel 2>&1 query --repository_cache='' --config=remote-minimal @bazel_features//:all)\n  BAZEL_EXIT_CODE=$?\n  # If stderr contains 'could not download Bazel' then return with code 125\n  # to skip the current commit during bisect.\n  if [[ $BAZEL_EXIT_CODE -ne 0 && $STDERROUT == *\"could not download Bazel\"* ]]; then\n    echo \"Bazel download failed. Skipping commit $USE_BAZEL_VERSION.\"\n    exit 125\n  fi\n  if [[ $BAZEL_EXIT_CODE -ne 0 ]]; then\n    echo \"Bazel query failed with exit code $BAZEL_EXIT_CODE.\"\n  fi\n  exit $BAZEL_EXIT_CODE\n)\n\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Explanation"}),":"]}),"\n",(0,s.jsxs)(t.p,{children:["First, we want to export the ",(0,s.jsx)(t.code,{children:"USE_BAZEL_VERSION"})," environment variable to the commit hash that we are currently bisecting. This will tell Bazelisk to use the pre-built binary from the GCS bucket that belongs to this commit. However, we won't use BISECT_HEAD just yet since we want to verify that this script works first. Knowing that ",(0,s.jsx)(t.code,{children:"8.0.1"})," was the last known good commit, we can set the ",(0,s.jsx)(t.code,{children:"USE_BAZEL_VERSION"})," to do a sanity check."]}),"\n",(0,s.jsxs)(t.p,{children:["Next, since we are not using Bazelisk bisect feature, the automatic cleanup feature of ",(0,s.jsx)(t.code,{children:"BAZELISK_CLEAN"})," won't work.\nInstead, we will manually clean the workspace after each test run with ",(0,s.jsx)(t.code,{children:"bazel clean --expunge"})," to achieve similar result."]}),"\n",(0,s.jsxs)(t.p,{children:["After that, we want to make sure that we handle the download issue as some commits might be missing from the GCS bucket.\n",(0,s.jsx)(t.code,{children:"git bisect run"})," allows us to skip the current commit by returning with an exit code of ",(0,s.jsx)(t.code,{children:"125"}),"."]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"The special exit code 125 should be used when the current source code cannot be tested.\nIf the script exits with this code, the current revision will be skipped"}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["So we check if the Bazel query failed with the error message ",(0,s.jsx)(t.code,{children:"could not download Bazel"})," and return with the exit code ",(0,s.jsx)(t.code,{children:"125"})," to skip the current commit.\nOtherwise, we return with the exit code of the Bazel query command."]}),"\n",(0,s.jsxs)(t.p,{children:["Now let's verify that our script works on ",(0,s.jsx)(t.code,{children:"8.0.1"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ ./test-buildbuddy.sh\nStarting local Bazel server (no_version) and connecting to it...\n...\n@rules_cc//:empty_lib\n@rules_cc//:link_extra_lib\n@rules_cc//:link_extra_libs\nLoading: 1 packages loaded\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Now let's edit the script to use the ",(0,s.jsx)(t.code,{children:"USE_BAZEL_VERSION"})," from the ",(0,s.jsx)(t.code,{children:"BISECT_HEAD"})," file for the bisect run and run the bisect:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ cat test-buildbuddy.sh\n#!/bin/bash\n\n# export USE_BAZEL_VERSION='8.0.1'\nexport USE_BAZEL_VERSION=$(cat .git/BISECT_HEAD)\n...\n\n$ git bisect run ./test-buildbuddy.sh\nrunning './run.sh'\nBisecting: 23 revisions left to test after this (roughly 5 steps)\n[11e85a4dc73f93ef25809e7d5f0409aaca7d42f1] [8.1.0] Respect comprehension variable shadowing in Starlark debugger output (#25139)\nrunning './run.sh'\nBazel download failed. Skipping commit 11e85a4dc73f93ef25809e7d5f0409aaca7d42f1.\n2025/02/18 13:18:12 Using unreleased version at commit 11e85a4dc73f93ef25809e7d5f0409aaca7d42f1\n2025/02/18 13:18:12 Downloading https://storage.googleapis.com/bazel-builds/artifacts/macos_arm64/11e85a4dc73f93ef25809e7d5f0409aaca7d42f1/bazel...\n2025/02/18 13:18:12 Skipping basic authentication for storage.googleapis.com because no credentials found in /Users/sluongng/.netrc\n2025/02/18 13:18:12 could not download Bazel: failed to download bazel: failed to download bazel: HTTP GET https://storage.googleapis.com/bazel-builds/artifacts/macos_arm64/11e85a4dc73f93ef25809e7d5f0409aaca7d42f1/bazel failed with error 404\nBisecting: 23 revisions left to test after this (roughly 5 steps)\n[12a3fc001b6629b52f5b24dce6018884222a0608] [8.1.0] See and use more than 64 CPUs on Windows (#25140)\nrunning './run.sh'\nBisecting: 10 revisions left to test after this (roughly 4 steps)\n[af6307bc6832d66cce772c5170961b4ff4521e48] [8.1.0] Configure `--run_under` target for the test exec platform (#25184)\nrunning './run.sh'\nBisecting: 4 revisions left to test after this (roughly 3 steps)\n[14219c4698e112a03ebe62eed7cb324f625f13c8] [8.1.0] Use digest function matching the checksum in gRPC remote downloader (#25225)\nrunning './run.sh'\nBazel query failed with exit code 1.\nBisecting: 2 revisions left to test after this (roughly 2 steps)\n[5f3a083d5649715dc0bed811ef41f53b91539d1d] [8.1.0] Update to use coverage_output_generator-v2.8 (#25202)\nrunning './run.sh'\nBisecting: 1 revision left to test after this (roughly 1 step)\n[a40a0cd9947dd73ec07f2394d108eb7e98745161] [8.1.0] Add version selector buttons to repo rule docs (#25211)\nrunning './run.sh'\nBisecting: 0 revisions left to test after this (roughly 0 steps)\n[aa4531d5a2116f85b80a753c53528032ed3cda71] [8.1.0] Don't suggest updates to private repo rule attributes (#25213)\nrunning './run.sh'\n14219c4698e112a03ebe62eed7cb324f625f13c8 is the first bad commit\ncommit 14219c4698e112a03ebe62eed7cb324f625f13c8\nAuthor: bazel.build machine account <ci.bazel@gmail.com>\nDate:   Fri Feb 7 12:07:48 2025 +0100\n\n    [8.1.0] Use digest function matching the checksum in gRPC remote downloader (#25225)\n\n    Fixes https://bazelbuild.slack.com/archives/CA31HN1T3/p1738763759125489\n\n    Closes #25206.\n\n    PiperOrigin-RevId: 724267755\n    Change-Id: Ia23bdae310231bd0ee5763311b948f3465aa8ed0\n\n    Commit\n    https://github.com/bazelbuild/bazel/commit/ef45e02bfb4af1124bb9ad1ef94f36c70c82ce48\n\n    Co-authored-by: Fabian Meumertzheim <fabian@meumertzhe.im>\n\n .../remote/downloader/GrpcRemoteDownloader.java    | 23 ++++++++++++++--------\n .../downloader/GrpcRemoteDownloaderTest.java       | 23 +++++++++++++---------\n 2 files changed, 29 insertions(+), 17 deletions(-)\nbisect found first bad commit\n"})}),"\n",(0,s.jsxs)(t.p,{children:["And voil\xe0! We have found the commit that introduced the issue.\nIt was ",(0,s.jsx)(t.code,{children:"14219c4698e112a03ebe62eed7cb324f625f13c8"}),", which was introduced in Bazel ",(0,s.jsx)(t.code,{children:"8.1.0"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["We won't be diving into the details of this specific issue in this blog post,\nbut if you are interested, you can read more about it via ",(0,s.jsx)(t.a,{href:"https://github.com/bazelbuild/bazel/pull/25320",children:"the revert PR #25320"}),".\nWe expect this to be fixed in the upcoming Bazel 8.1.1 release."]}),"\n",(0,s.jsx)(t.h2,{id:"build-failed-after-upgrading-a-dependency",children:"Build failed after upgrading a dependency"}),"\n",(0,s.jsxs)(t.p,{children:["This bisect technique can also be used to troubleshoot issues that arise after upgrading a Bazel dependency.\nFor example, recently we attempted upgrading ",(0,s.jsx)(t.code,{children:"@rules_go"})," in our repository from ",(0,s.jsx)(t.code,{children:"v0.51.0"})," to ",(0,s.jsx)(t.code,{children:"v0.53.0"}),", and the build failed."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'$ bazel build server\n...\nERROR: /private/var/tmp/_bazel_sluongng/06e573a93bc2d6a9cad4ad41f00b4310/external/bazel_gazelle/internal/go_repository_cache.bzl:30:17: An error occurred during the fetch of repository \'bazel_gazelle_go_repository_cache\':\n   Traceback (most recent call last):\n\tFile "/private/var/tmp/_bazel_sluongng/06e573a93bc2d6a9cad4ad41f00b4310/external/bazel_gazelle/internal/go_repository_cache.bzl", line 30, column 17, in _go_repository_cache_impl\n\t\tfail(\'gazelle found more than one suitable Go SDK ({}). Specify which one to use with gazelle_dependencies(go_sdk = "go_sdk").\'.format(", ".join(matches)))\nError in fail: gazelle found more than one suitable Go SDK (go_host_compatible_sdk_label, go_sdk_darwin_arm64). Specify which one to use with gazelle_dependencies(go_sdk = "go_sdk").\nERROR: no such package \'@@org_golang_google_grpc//reflection\': gazelle found more than one suitable Go SDK (go_host_compatible_sdk_label, go_sdk_darwin_arm64). Specify which one to use with gazelle_dependencies(go_sdk = "go_sdk").\nERROR: /Users/sluongng/work/buildbuddy-io/buildbuddy/cli/cmd/sidecar/BUILD:3:11: //cli/cmd/sidecar:sidecar depends on @@org_golang_google_grpc//reflection:reflection in repository @@org_golang_google_grpc which failed to fetch. no such package \'@@org_golang_google_grpc//reflection\': gazelle found more than one suitable Go SDK (go_host_compatible_sdk_label, go_sdk_darwin_arm64). Specify which one to use with gazelle_dependencies(go_sdk = "go_sdk").\nERROR: Analysis of target \'//cli:cli\' failed; build aborted: Analysis failed\n...\n'})}),"\n",(0,s.jsxs)(t.p,{children:["This time, we can use the same bisect technique to identify the commit that introduced the issue.\nTo make the ",(0,s.jsx)(t.code,{children:"git bisect"})," a bit less tedious, let's use a local copy of ",(0,s.jsx)(t.code,{children:"@rules_go"})," instead of the one managed by Bazel."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ cd ~/work/bazelbuild\n$ git clone https://github.com/bazel-contrib/rules_go.git\n$ cd rules_go\n$ git checkout v0.51.0\n"})}),"\n",(0,s.jsxs)(t.p,{children:["With this, we can add the following lines to our ",(0,s.jsx)(t.code,{children:".bazelrc"})," to tell Bazel to use our local copy instead of the one managed by Bazel."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ cd ~/work/buildbuddy-io/buildbuddy\n$ tail -n 5 .bazelrc\n## BZLMOD\ncommon --override_module=rules_go=/Users/sluongng/work/bazelbuild/rules_go\n\n## WORKSPACE\ncommon --override_repository=io_bazel_rules_go=/Users/sluongng/work/bazelbuild/rules_go\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Pro tips:"})," These flags are really handy, so I would recommend keeping them in your ",(0,s.jsx)(t.code,{children:".bazelrc"})," file as comments for future use."]}),"\n",(0,s.jsxs)(t.p,{children:["Now we can start the bisect process in the ",(0,s.jsx)(t.code,{children:"@rules_go"})," repository."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ cd ~/work/bazelbuild/rules_go\n$ cat test-rules-go.sh\n#!/bin/bash\n\n(\n  cd ~/work/buildbuddy-io/buildbuddy\n  bazel build server\n)\n$ chmod +x test-rules-go.sh\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Since we are relying on our local copy of ",(0,s.jsx)(t.code,{children:"@rules_go"}),", we do not need to handle the download issue like the previous script.\nWe are also not expecting the build to fail because of external factors, so no need for setting ",(0,s.jsx)(t.code,{children:"BAZELISK_CLEAN"})," or handling our own cleanup.\nThis also means that we are reusing the same Bazel JVM process for each bisect run, taking advantage of the hot analysis cache to keep our builds blazingly fast."]}),"\n",(0,s.jsx)(t.p,{children:"Now let's start the bisect process:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ cd ~/work/bazelbuild/rules_go\n$ git bisect start --first-parent v0.53.0 v0.51.0\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Note here that we do NOT want to use the ",(0,s.jsx)(t.code,{children:"--no-checkout"})," flag as the working copy of the repo is used for the bisect run and therefore, needs to be updated."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"$ git bisect run ./test-rules-go.sh\nrunning './test-rules-go.sh'\nBisecting: 8 revisions left to test after this (roughly 3 steps)\n[4f5202adf56521b3048536d04eef12690557fa7c] Mention `dev_dependency` in `go_sdk.host` error (#4246)\nrunning './test-rules-go.sh'\nBisecting: 4 revisions left to test after this (roughly 2 steps)\n[66477c1b41b2449c8102f4338d011f07e4df04b6] Update documentation reference (#4237)\nrunning './test-rules-go.sh'\nBisecting: 1 revision left to test after this (roughly 1 step)\n[5eb06119c49b97f16aa79d53cdcd99f95b1000bf] Allow .so files to have more extensions (#4232)\nrunning './test-rules-go.sh'\nBisecting: 0 revisions left to test after this (roughly 0 steps)\n[d25e4e75f0ce8e419593a5c633f852ff1c08e292] Use same Go SDK as Gazelle for `go_bazel_test` (#4231)\nrunning './test-rules-go.sh'\nd25e4e75f0ce8e419593a5c633f852ff1c08e292 is the first bad commit\ncommit d25e4e75f0ce8e419593a5c633f852ff1c08e292\nAuthor: Fabian Meumertzheim <fabian@meumertzhe.im>\nDate:   Thu Jan 16 08:13:09 2025 +0100\n\n    Use same Go SDK as Gazelle for `go_bazel_test` (#4231)\n\n    **What type of PR is this?**\n\n    Bug fix\n\n    **What does this PR do? Why is it needed?**\n\n    **Which issues(s) does this PR fix?**\n\n    Fixes #4228\n\n    **Other notes for review**\n\n MODULE.bazel                       |  2 +-\n go/private/repositories.bzl        | 11 +++++++++++\n go/tools/bazel_testing/BUILD.bazel |  9 ++++++---\n 3 files changed, 18 insertions(+), 4 deletions(-)\nbisect found first bad commit\n"})}),"\n",(0,s.jsxs)(t.p,{children:["And there you have it! The issue was introduced in commit ",(0,s.jsx)(t.code,{children:"d25e4e75f0ce8e419593a5c633f852ff1c08e292"})," in the ",(0,s.jsx)(t.code,{children:"@rules_go"})," repository, which was introduced in ",(0,s.jsx)(t.code,{children:"v0.53.0"}),".\nThis was also fixed swiftly by Fabian in rules_go's ",(0,s.jsx)(t.a,{href:"https://github.com/bazel-contrib/rules_go/pull/4264",children:"PR #4264"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsxs)(t.p,{children:["Using ",(0,s.jsx)(t.code,{children:"git bisect"})," to troubleshoot build failures after upgrading Bazel or its dependencies can be a powerful tool.\nThis helps us narrow down the root cause of the issue to the exact commit that introduced it."]}),"\n",(0,s.jsx)(t.p,{children:"This makes the error much more actionable.\nFor example, when we were able to identify the issue to be in rules_go@v0.53.0, we were able to upgrade to v0.52.0 instead and reported the fix to the upstream open-source project.\nIn other cases, we can proceed with the upgrade but with a specific revert of the commit that introduced the issue patched into the external dependencies."}),"\n",(0,s.jsx)(t.p,{children:"I hope this guide was helpful to you and that you can use it to troubleshoot your external dependency upgrades in the future."})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>l});var i=n(96540);const s={},o=i.createContext(s);function a(e){const t=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:t},e.children)}},6951:e=>{e.exports=JSON.parse('{"permalink":"/blog/bisect-bazel","editUrl":"https://github.com/buildbuddy-io/buildbuddy/edit/master/website/blog/bisect-bazel.md","source":"@site/blog/bisect-bazel.md","title":"Troubleshooting Bazel with Git Bisect","description":"A guide to using Git bisect to troubleshoot Bazel issues","date":"2025-02-18T12:00:00.000Z","tags":[{"inline":true,"label":"bazel","permalink":"/blog/tags/bazel"},{"inline":true,"label":"git","permalink":"/blog/tags/git"},{"inline":true,"label":"engineering","permalink":"/blog/tags/engineering"}],"readingTime":12.785,"hasTruncateMarker":true,"authors":[{"name":"Son Luong Ngoc","title":"Solution Engineer @ BuildBuddy","url":"https://github.com/sluongng/","imageURL":"https://avatars.githubusercontent.com/u/26684313?v=4","key":"son","page":null}],"frontMatter":{"slug":"bisect-bazel","title":"Troubleshooting Bazel with Git Bisect","description":"A guide to using Git bisect to troubleshoot Bazel issues","authors":"son","date":"2025-02-18:12:00:00","image":"/img/blog/troubleshooting.png","tags":["bazel","git","engineering"]},"unlisted":false,"prevItem":{"title":"Unusual Builds with Bytes","permalink":"/blog/unusual-builds-w-bytes"},"nextItem":{"title":"Welcoming Vanja Pejovic","permalink":"/blog/welcoming-vanja-pejovic"}}')}}]);