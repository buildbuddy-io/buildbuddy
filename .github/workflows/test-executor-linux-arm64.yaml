name: "Test linux/arm64 executor"

on:
  push:
    branches:
      - "master"
  pull_request:
    branches:
      - "*"

jobs:
  build:
    runs-on: ubuntu-22.04-16cpu-arm64
    if: "!contains(github.event.head_commit.message, 'ci skip')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # GitHub's arm64 runners do not have the same pre-installed software as
      # the amd64 runners so we have to install a few things here.

      - name: Install bazelisk
        run: |
          curl -L --output /tmp/bazelisk https://github.com/bazelbuild/bazelisk/releases/download/v1.17.0/bazelisk-linux-arm64
          chmod +x /tmp/bazelisk
          sudo mv /tmp/bazelisk /usr/bin/bazelisk
          sudo ln -s /usr/bin/bazelisk /usr/bin/bazel

      - name: Install apt packages
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++

      - name: Run tests
        run: |
          BUILD_FLAGS=(
            --config=cache
            --bes_backend=remote.buildbuddy.io
            --bes_results_url=https://app.buildbuddy.io/invocation/
            --remote_cache=remote.buildbuddy.io
            --flaky_test_attempts=3
            --local_test_jobs=4
            --build_metadata=ROLE=CI
            --color=yes
          )
          bazel test "${BUILD_FLAGS[@]}" --test_tag_filters=-performance,-docker \
            //enterprise/server/remote_execution/... \
            //enterprise/server/test/integration/remote_execution/...

          # Run a separate bazel invocation to invoke tests with the "docker" tag.
          # TODO: improve platform setup so that we can run this whenever the
          # host has podman available.
          bazel test "${BUILD_FLAGS[@]}" --test_tag_filters=+docker \
            //enterprise/server/test/integration/podman:podman_test
